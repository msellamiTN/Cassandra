<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Cassandra CQL Web Editor</title>
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    header {
      background: #2d3e50;
      color: white;
      padding: 10px 20px;
    }
    h1 {
      margin: 0;
      font-size: 20px;
    }
    main {
      padding: 20px;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 15px;
    }
    .tab {
      padding: 8px 16px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      font-size: 14px;
      background: #ecf0f1;
    }
    .tab.active {
      border-color: #ccc;
      background: #ffffff;
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
    }
    .tab-content {
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 0 4px 4px 4px;
      padding: 15px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 160px;
    }
    label {
      font-size: 13px;
      margin-bottom: 4px;
    }
    input, textarea {
      font-family: "Consolas", "Courier New", monospace;
      font-size: 14px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      min-height: 150px;
      resize: vertical;
    }
    /* CodeMirror Editor Styles */
    .CodeMirror {
      font-family: "Fira Code", "Consolas", "Monaco", "Courier New", monospace;
      font-size: 14px;
      line-height: 1.5;
      border: 1px solid #ccc;
      border-radius: 4px;
      height: auto;
      min-height: 300px;
    }
    .CodeMirror-scroll {
      min-height: 300px;
      max-height: 600px;
    }
    .CodeMirror-gutters {
      border-right: 1px solid #ddd;
      background-color: #f7f7f7;
    }
    /* Comment styling - vert avec style italique */
    .CodeMirror .cm-comment {
      color: #6a9955 !important;
      font-style: italic !important;
      background-color: rgba(106, 153, 85, 0.1);
    }
    /* SQL Keywords - bleu avec gras */
    .CodeMirror .cm-keyword {
      color: #569cd6 !important;
      font-weight: bold !important;
    }
    /* Strings - orange/rouge */
    .CodeMirror .cm-string {
      color: #ce9178 !important;
    }
    /* Numbers - vert clair */
    .CodeMirror .cm-number {
      color: #b5cea8 !important;
    }
    /* Operators */
    .CodeMirror .cm-operator {
      color: #d4d4d4 !important;
    }
    /* Built-in functions */
    .CodeMirror .cm-builtin {
      color: #4ec9b0 !important;
    }
    /* Variables/identifiers */
    .CodeMirror .cm-variable {
      color: #9cdcfe !important;
    }
    /* Property names */
    .CodeMirror .cm-property {
      color: #9cdcfe !important;
    }
    /* Editor container */
    .editor-wrapper {
      position: relative;
      margin-bottom: 10px;
    }
    .editor-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .font-size-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .font-size-control label {
      font-size: 12px;
      margin: 0;
    }
    .font-size-control input[type="range"] {
      width: 100px;
    }
    .font-size-display {
      font-size: 12px;
      color: #666;
      min-width: 40px;
    }
    button {
      padding: 8px 16px;
      background: #1abc9c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    button:hover {
      background: #16a085;
    }
    .btn-secondary {
      background: #3498db;
    }
    .btn-secondary:hover {
      background: #2980b9;
    }
    .status {
      margin-top: 10px;
      font-size: 13px;
    }
    .status.error {
      color: #c0392b;
    }
    .status.success {
      color: #27ae60;
    }
    .status.info {
      color: #7f8c8d;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      font-size: 13px;
    }
    th {
      background: #ecf0f1;
      text-align: left;
    }
    .results-container {
      overflow: auto;
      max-height: 400px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background: white;
      padding: 10px;
      box-sizing: border-box;
    }
    .results-empty {
      color: #7f8c8d;
      font-style: italic;
    }
    .query-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .saved-queries {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
    }
    .saved-queries-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      background: #f9f9f9;
      margin-top: 8px;
    }
    .saved-query-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      margin-bottom: 4px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 3px;
      cursor: pointer;
    }
    .saved-query-item:hover {
      background: #f0f0f0;
    }
    .saved-query-item.active {
      background: #e3f2fd;
      border-color: #3498db;
    }
    .saved-query-name {
      flex: 1;
      font-weight: bold;
      font-size: 13px;
    }
    .saved-query-preview {
      flex: 2;
      font-size: 12px;
      color: #666;
      margin: 0 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .saved-query-actions {
      display: flex;
      gap: 5px;
    }
    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
    }
    .btn-danger {
      background: #e74c3c;
    }
    .btn-danger:hover {
      background: #c0392b;
    }
    .batch-result {
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f9f9f9;
    }
    .batch-result-header {
      font-weight: bold;
      margin-bottom: 8px;
      color: #2d3e50;
    }
    .batch-result.success {
      border-left: 4px solid #27ae60;
    }
    .batch-result.error {
      border-left: 4px solid #e74c3c;
    }
    .query-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .query-input-group input {
      flex: 1;
    }
    /* Layout avec barre latérale */
    .editor-layout {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }
    .editor-main {
      flex: 1 1 0;
      min-width: 0;
    }
    .sidebar {
      width: 320px;
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      position: sticky;
      top: 12px;
      max-height: 85vh;
      overflow: auto;
    }
    .sidebar-section {
      margin-bottom: 12px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .sidebar-section:last-child {
      border-bottom: none;
      padding-bottom: 0;
      margin-bottom: 0;
    }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .sidebar-header h3 {
      margin: 0;
      font-size: 14px;
      color: #2d3e50;
    }
    .sidebar-body {
      font-size: 13px;
      color: #444;
      line-height: 1.4;
    }
    .meta-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 180px;
      overflow-y: auto;
    }
    .meta-item {
      padding: 8px;
      border: 1px solid #e1e4e8;
      border-radius: 4px;
      cursor: pointer;
      background: #fafafa;
      transition: background 0.15s, border-color 0.15s;
    }
    .meta-item:hover {
      background: #f0f6ff;
      border-color: #bcd3ff;
    }
    .meta-item.active {
      background: #e6f0ff;
      border-color: #7da6ff;
    }
    .meta-item-title {
      font-weight: 600;
      color: #2d3e50;
      margin-bottom: 2px;
    }
    .meta-item-sub {
      font-size: 12px;
      color: #666;
    }
    .meta-empty {
      font-size: 12px;
      color: #888;
      font-style: italic;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 11px;
      background: #e9f5ff;
      color: #1b6fbf;
      margin-left: 6px;
    }
    /* Icônes */
    .icon {
      margin-right: 6px;
      width: 14px;
      text-align: center;
      display: inline-block;
    }
    .icon-success {
      color: #27ae60;
    }
    .icon-error {
      color: #e74c3c;
    }
    .icon-info {
      color: #3498db;
    }
    .icon-warning {
      color: #f39c12;
    }
    /* Import file button */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    .file-input-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #3498db;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }
    .file-input-label:hover {
      background: #2980b9;
    }
    .file-input-label i {
      font-size: 12px;
    }
  </style>
  <!-- CodeMirror JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>
</head>
<body>
<header>
  <h1>Cassandra CQL Web Editor</h1>
</header>
<main>
  <div class="tabs">
    <div class="tab active" data-tab="config">Configuration du cluster</div>
    <div class="tab" data-tab="editor">Éditeur CQL</div>
  </div>

  <div id="tab-config" class="tab-content">
    <div class="form-row">
      <div class="form-group">
        <label for="hosts">Hôtes (séparés par des virgules)</label>
        <input id="hosts" type="text" placeholder="127.0.0.1,192.168.0.10" />
      </div>
      <div class="form-group" style="max-width: 120px;">
        <label for="port">Port</label>
        <input id="port" type="number" value="9042" />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="username">Utilisateur (optionnel)</label>
        <input id="username" type="text" />
      </div>
      <div class="form-group">
        <label for="password">Mot de passe (optionnel)</label>
        <input id="password" type="password" />
      </div>
      <div class="form-group">
        <label for="keyspace">Keyspace (optionnel)</label>
        <input id="keyspace" type="text" placeholder="ex: my_keyspace" />
      </div>
    </div>

    <button id="saveConfigBtn" class="btn-secondary">Sauvegarder & Tester la connexion</button>
    <div id="configStatus" class="status info">Aucun test de connexion encore effectué.</div>
  </div>

  <div id="tab-editor" class="tab-content" style="display: none;">
    <div class="editor-layout">
      <div class="editor-main">
        <section class="editor-container">
          <div class="editor-controls">
            <label for="cql" style="flex: 1;">Requête(s) CQL (séparées par des points-virgules, commentaires avec -- ou /* */) :</label>
            <div class="font-size-control">
              <label for="fontSize">Taille :</label>
              <input type="range" id="fontSize" min="10" max="20" value="14" step="1" />
              <span class="font-size-display" id="fontSizeDisplay">14px</span>
            </div>
          </div>
          <div class="editor-wrapper">
            <textarea id="cql" placeholder="Exemple : SELECT * FROM system.local;&#10;SELECT * FROM system.peers;&#10;&#10;Astuce : Sélectionnez une requête ou placez le curseur sur une requête pour l'exécuter seule.&#10;Les commentaires (-- et /* */) sont automatiquement ignorés."></textarea>
          </div>
          <div id="queryPreview" class="status info" style="display: none; margin-top: 5px; font-size: 12px; font-style: italic;"></div>
          <div class="query-actions">
            <button id="runBtn"><i class="fas fa-play icon"></i>Exécuter (sélection/cursor)</button>
            <button id="runAllBtn" class="btn-secondary"><i class="fas fa-forward icon"></i>Exécuter tout</button>
            <div class="file-input-wrapper">
              <input type="file" id="importFile" accept=".cql,.sql,.txt" />
              <label for="importFile" class="file-input-label">
                <i class="fas fa-file-import"></i>Importer CQL
              </label>
            </div>
            <div class="query-input-group">
              <input type="text" id="queryName" placeholder="Nom de la requête..." />
              <button id="saveQueryBtn" class="btn-secondary btn-small"><i class="fas fa-save icon"></i>Sauvegarder</button>
            </div>
          </div>
          <div id="status" class="status"></div>
        </section>

        <section class="saved-queries">
          <h3>Requêtes sauvegardées</h3>
          <div id="savedQueriesList" class="saved-queries-list">
            <div class="results-empty">Aucune requête sauvegardée.</div>
          </div>
        </section>

        <section>
          <h2>Résultats</h2>
          <div id="results" class="results-container">
            <div class="results-empty">Aucun résultat pour l'instant.</div>
          </div>
        </section>
      </div>

      <aside class="sidebar">
        <div class="sidebar-section">
          <div class="sidebar-header">
            <h3><i class="fas fa-server icon"></i>Statut serveur</h3>
            <button id="refreshStatusBtn" class="btn-secondary btn-small"><i class="fas fa-sync-alt icon"></i>Rafraîchir</button>
          </div>
          <div id="serverStatus" class="sidebar-body meta-empty"><i class="fas fa-times-circle icon icon-error"></i>Non connecté.</div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-header">
            <h3><i class="fas fa-database icon"></i>Keyspaces</h3>
            <button id="refreshMetaBtn" class="btn-secondary btn-small"><i class="fas fa-sync-alt icon"></i>Rafraîchir</button>
          </div>
          <div id="keyspaceList" class="meta-list">
            <div class="meta-empty"><i class="fas fa-info-circle icon"></i>Aucun keyspace chargé.</div>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-header">
            <h3><i class="fas fa-table icon"></i>Tables</h3>
          </div>
          <div id="tableList" class="meta-list">
            <div class="meta-empty"><i class="fas fa-info-circle icon"></i>Aucune table.</div>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-header">
            <h3><i class="fas fa-info-circle icon"></i>Détails</h3>
          </div>
          <div id="tableDetails" class="sidebar-body meta-empty"><i class="fas fa-mouse-pointer icon"></i>Sélectionnez une table.</div>
        </div>
      </aside>
    </div>
  </div>
</main>

<script>
  const tabs = document.querySelectorAll('.tab');
  const tabConfig = document.getElementById('tab-config');
  const tabEditor = document.getElementById('tab-editor');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const target = tab.getAttribute('data-tab');
      if (target === 'config') {
        tabConfig.style.display = 'block';
        tabEditor.style.display = 'none';
      } else {
        tabConfig.style.display = 'none';
        tabEditor.style.display = 'block';
      }
    });
  });

  const hostsInput = document.getElementById('hosts');
  const portInput = document.getElementById('port');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  const keyspaceInput = document.getElementById('keyspace');
  const saveConfigBtn = document.getElementById('saveConfigBtn');
  const configStatus = document.getElementById('configStatus');

  const runBtn = document.getElementById('runBtn');
  const cqlTextarea = document.getElementById('cql');
  const statusDiv = document.getElementById('status');
  const resultsDiv = document.getElementById('results');
  const saveQueryBtn = document.getElementById('saveQueryBtn');
  const queryNameInput = document.getElementById('queryName');
  const savedQueriesList = document.getElementById('savedQueriesList');
  const queryPreview = document.getElementById('queryPreview');
  const fontSizeControl = document.getElementById('fontSize');
  const fontSizeDisplay = document.getElementById('fontSizeDisplay');
  const serverStatusDiv = document.getElementById('serverStatus');
  const keyspaceListDiv = document.getElementById('keyspaceList');
  const tableListDiv = document.getElementById('tableList');
  const tableDetailsDiv = document.getElementById('tableDetails');
  const refreshStatusBtn = document.getElementById('refreshStatusBtn');
  const refreshMetaBtn = document.getElementById('refreshMetaBtn');

  let selectedKeyspace = null;
  let selectedTable = null;

  // Initialiser CodeMirror
  let codeEditor = null;
  
  function initCodeEditor() {
    codeEditor = CodeMirror.fromTextArea(cqlTextarea, {
      mode: {
        name: 'sql',
        keywords: {
          // Mots-clés CQL/Cassandra additionnels
          all: true, alter: true, and: true, any: true, as: true, asc: true,
          authorize: true, batch: true, begin: true, by: true, called: true,
          cluster: true, columnfamily: true, compact: true, consistency: true,
          count: true, create: true, delete: true, desc: true, describe: true,
          distinct: true, drop: true, each_quorum: true, from: true, full: true,
          grant: true, if: true, in: true, index: true, infile: true, insert: true,
          into: true, is: true, keyspace: true, keyspaces: true, level: true,
          limit: true, local_quorum: true, materialized: true, modify: true,
          no: true, not: true, null: true, of: true, on: true, one: true,
          or: true, order: true, password: true, primary: true, quorum: true,
          rename: true, revoke: true, schema: true, select: true, set: true,
          sstable: true, table: true, three: true, to: true, token: true,
          truncate: true, two: true, unlogged: true, update: true, use: true,
          using: true, view: true, where: true, with: true
        }
      },
      theme: 'default',
      lineNumbers: true,
      lineWrapping: true,
      indentWithTabs: false,
      indentUnit: 2,
      matchBrackets: true,
      autoCloseBrackets: true,
      styleActiveLine: true,
      extraKeys: {
        "Ctrl-Enter": function() { executeQuery(); },
        "Cmd-Enter": function() { executeQuery(); }
      }
    });

    // Mettre à jour la taille de police
    fontSizeControl.addEventListener('input', function() {
      const size = this.value;
      fontSizeDisplay.textContent = size + 'px';
      codeEditor.getWrapperElement().style.fontSize = size + 'px';
      codeEditor.refresh();
    });

    // Initialiser la taille
    codeEditor.getWrapperElement().style.fontSize = fontSizeControl.value + 'px';
    
    // Mettre à jour l'aperçu lors des changements
    codeEditor.on('cursorActivity', updateQueryPreview);
    codeEditor.on('change', updateQueryPreview);
  }

  // Fonction pour obtenir la valeur de l'éditeur
  function getEditorValue() {
    return codeEditor ? codeEditor.getValue() : cqlTextarea.value;
  }

  // Fonction pour définir la valeur de l'éditeur
  function setEditorValue(value) {
    if (codeEditor) {
      codeEditor.setValue(value);
    } else {
      cqlTextarea.value = value;
    }
  }

  // Fonction pour obtenir la sélection ou la position du curseur dans CodeMirror
  function getEditorSelection() {
    if (!codeEditor) {
      return { start: cqlTextarea.selectionStart, end: cqlTextarea.selectionEnd };
    }
    const selection = codeEditor.getSelection();
    if (selection) {
      return { start: codeEditor.getCursor('start'), end: codeEditor.getCursor('end'), text: selection };
    }
    return { start: codeEditor.getCursor(), end: codeEditor.getCursor(), text: null };
  }

  // Afficher un aperçu de la requête qui sera exécutée
  function updateQueryPreview() {
    const query = getQueryAtCursor();
    if (query && query.length > 0) {
      const preview = query.length > 100 ? query.substring(0, 100) + '...' : query;
      queryPreview.textContent = 'Requête à exécuter : ' + preview.replace(/\n/g, ' ');
      queryPreview.style.display = 'block';
    } else {
      queryPreview.style.display = 'none';
    }
  }

  // Mettre à jour l'aperçu (CodeMirror gère ses propres événements)
  if (!codeEditor) {
    cqlTextarea.addEventListener('mouseup', updateQueryPreview);
    cqlTextarea.addEventListener('keyup', updateQueryPreview);
    cqlTextarea.addEventListener('selectionchange', updateQueryPreview);
  }

  // Helpers de requêtes API
  async function fetchJson(url, opts = {}) {
    const res = await fetch(url, opts);
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.detail || res.statusText);
    }
    return res.json();
  }

  // ---- Métadonnées (statut, keyspaces, tables) ----
  function renderServerStatus(data) {
    if (!data || !data.connected) {
      serverStatusDiv.innerHTML = '<div class="meta-empty"><i class="fas fa-times-circle icon icon-error"></i>Non connecté.</div>';
      return;
    }
    const hosts = (data.hosts || []).join(', ');
    serverStatusDiv.innerHTML = `
      <div><i class="fas fa-check-circle icon icon-success"></i><strong>Connecté</strong></div>
      <div style="margin-top: 6px;"><i class="fas fa-network-wired icon icon-info"></i><strong>Cluster :</strong> ${data.cluster_name || 'N/A'}</div>
      <div><i class="fas fa-server icon icon-info"></i><strong>Hôtes :</strong> ${hosts || 'N/A'}</div>
      <div><i class="fas fa-database icon icon-info"></i><strong>Keyspace courant :</strong> ${data.keyspace || 'non défini'}</div>
    `;
  }

  function renderKeyspaces(list) {
    if (!list || list.length === 0) {
      keyspaceListDiv.innerHTML = '<div class="meta-empty"><i class="fas fa-info-circle icon"></i>Aucun keyspace.</div>';
      return;
    }
    keyspaceListDiv.innerHTML = '';
    list.forEach((ks) => {
      const div = document.createElement('div');
      div.className = 'meta-item' + (ks === selectedKeyspace ? ' active' : '');
      div.innerHTML = `<i class="fas fa-database icon"></i><span>${ks}</span>`;
      div.addEventListener('click', () => loadTables(ks));
      keyspaceListDiv.appendChild(div);
    });
  }

  function renderTables(tables) {
    if (!tables || tables.length === 0) {
      tableListDiv.innerHTML = '<div class="meta-empty"><i class="fas fa-info-circle icon"></i>Aucune table.</div>';
      tableDetailsDiv.innerHTML = '<i class="fas fa-mouse-pointer icon"></i>Sélectionnez une table.';
      selectedTable = null;
      return;
    }
    tableListDiv.innerHTML = '';
    tables.forEach((table) => {
      const div = document.createElement('div');
      div.className = 'meta-item' + (table.name === selectedTable ? ' active' : '');
      div.innerHTML = `
        <div class="meta-item-title"><i class="fas fa-table icon"></i>${table.name}</div>
        <div class="meta-item-sub"><i class="fas fa-columns icon"></i>${table.columns.length} colonne(s)</div>
      `;
      div.addEventListener('click', () => renderTableDetails(table));
      tableListDiv.appendChild(div);
    });
  }

  function renderTableDetails(table) {
    if (!table) {
      tableDetailsDiv.innerHTML = '<i class="fas fa-mouse-pointer icon"></i>Sélectionnez une table.';
      return;
    }
    selectedTable = table.name;
    const pk = table.partition_keys?.join(', ') || 'Aucune';
    const ck = table.clustering_keys?.join(', ') || 'Aucune';
    let cols = '';
    table.columns.forEach((c) => {
      const isPK = table.partition_keys?.includes(c.name);
      const isCK = table.clustering_keys?.includes(c.name);
      let icon = '<i class="fas fa-columns icon"></i>';
      if (isPK) icon = '<i class="fas fa-key icon icon-success"></i>';
      else if (isCK) icon = '<i class="fas fa-sort icon icon-info"></i>';
      cols += `<div style="margin-bottom: 4px;">${icon}<strong>${c.name}</strong> : <code>${c.type}</code></div>`;
    });
    tableDetailsDiv.innerHTML = `
      <div style="margin-bottom: 8px;"><i class="fas fa-table icon icon-info"></i><strong>Table :</strong> ${table.name}</div>
      <div style="margin-bottom: 4px;"><i class="fas fa-key icon icon-success"></i><strong>Partition key :</strong> ${pk}</div>
      <div style="margin-bottom: 8px;"><i class="fas fa-sort icon icon-info"></i><strong>Clustering :</strong> ${ck}</div>
      <div style="margin-top:8px; margin-bottom:4px;"><strong><i class="fas fa-list icon"></i>Colonnes :</strong></div>
      <div style="margin-top:4px;">${cols || '<div class="meta-empty">Aucune colonne</div>'}</div>
    `;
    document.querySelectorAll('#tableList .meta-item').forEach((el) => {
      const nameEl = el.querySelector('.meta-item-title');
      el.classList.toggle('active', nameEl && nameEl.textContent && nameEl.textContent.includes(table.name));
    });
  }

  async function loadStatus() {
    try {
      const data = await fetchJson('/api/status');
      renderServerStatus(data);
    } catch (e) {
      serverStatusDiv.innerHTML = `<div class="meta-empty">Erreur: ${e.message}</div>`;
    }
  }

  async function loadKeyspaces() {
    try {
      const data = await fetchJson('/api/keyspaces');
      const ksList = data.keyspaces || [];
      renderKeyspaces(ksList);
      if (selectedKeyspace && !ksList.includes(selectedKeyspace)) {
        selectedKeyspace = null;
        renderTables([]);
      }
      if (!selectedKeyspace && ksList.length > 0) {
        loadTables(ksList[0]);
      }
    } catch (e) {
      keyspaceListDiv.innerHTML = `<div class="meta-empty">Erreur: ${e.message}</div>`;
    }
  }

  async function loadTables(keyspace) {
    selectedKeyspace = keyspace;
    selectedTable = null;
    document.querySelectorAll('#keyspaceList .meta-item').forEach((el) => {
      el.classList.toggle('active', el.textContent === keyspace);
    });

    try {
      const data = await fetchJson(`/api/keyspaces/${encodeURIComponent(keyspace)}/tables`);
      renderTables(data.tables || []);
      tableDetailsDiv.innerHTML = 'Sélectionnez une table.';
    } catch (e) {
      tableListDiv.innerHTML = `<div class="meta-empty">Erreur: ${e.message}</div>`;
      tableDetailsDiv.innerHTML = 'Sélectionnez une table.';
    }
  }

  refreshStatusBtn.addEventListener('click', loadStatus);
  refreshMetaBtn.addEventListener('click', () => {
    loadStatus();
    loadKeyspaces();
  });

  // Gestion des requêtes sauvegardées
  const STORAGE_KEY = 'cql_saved_queries';

  function getSavedQueries() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : {};
    } catch (e) {
      return {};
    }
  }

  function saveQueries(queries) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(queries));
    } catch (e) {
      console.error('Erreur lors de la sauvegarde:', e);
    }
  }

  function loadSavedQueries() {
    const queries = getSavedQueries();
    const keys = Object.keys(queries);
    
    if (keys.length === 0) {
      savedQueriesList.innerHTML = '<div class="results-empty">Aucune requête sauvegardée.</div>';
      return;
    }

    let html = '';
    for (const name of keys.sort()) {
      const query = queries[name];
      const preview = query.length > 50 ? query.substring(0, 50) + '...' : query;
      html += `
        <div class="saved-query-item" data-name="${name}">
          <div class="saved-query-name"><i class="fas fa-file-code icon"></i>${name}</div>
          <div class="saved-query-preview">${preview.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
          <div class="saved-query-actions">
            <button class="btn-secondary btn-small load-query-btn" data-name="${name}"><i class="fas fa-upload icon"></i>Charger</button>
            <button class="btn-danger btn-small delete-query-btn" data-name="${name}"><i class="fas fa-trash icon"></i>Supprimer</button>
          </div>
        </div>
      `;
    }
    savedQueriesList.innerHTML = html;

    // Ajouter les event listeners
    document.querySelectorAll('.load-query-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const name = btn.getAttribute('data-name') || e.target.closest('.load-query-btn')?.getAttribute('data-name');
        if (name) loadQuery(name);
      });
    });

    document.querySelectorAll('.delete-query-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const name = btn.getAttribute('data-name') || e.target.closest('.delete-query-btn')?.getAttribute('data-name');
        if (name) deleteQuery(name);
      });
    });
  }

  function saveQuery() {
    const query = getEditorValue().trim();
    const name = queryNameInput.value.trim();

    if (!query) {
      alert('Veuillez saisir une requête à sauvegarder.');
      return;
    }

    if (!name) {
      alert('Veuillez donner un nom à cette requête.');
      return;
    }

    const queries = getSavedQueries();
    queries[name] = query;
    saveQueries(queries);
    loadSavedQueries();
    queryNameInput.value = '';
    
    statusDiv.textContent = `Requête "${name}" sauvegardée.`;
    statusDiv.className = 'status success';
  }

  function loadQuery(name) {
    const queries = getSavedQueries();
    if (queries[name]) {
      setEditorValue(queries[name]);
      queryNameInput.value = name;
      statusDiv.textContent = `Requête "${name}" chargée.`;
      statusDiv.className = 'status success';
      if (codeEditor) {
        codeEditor.refresh();
      }
    }
  }

  function deleteQuery(name) {
    if (!confirm(`Supprimer la requête "${name}" ?`)) {
      return;
    }

    const queries = getSavedQueries();
    delete queries[name];
    saveQueries(queries);
    loadSavedQueries();
    
    statusDiv.textContent = `Requête "${name}" supprimée.`;
    statusDiv.className = 'status info';
  }

  async function loadConfig() {
    try {
      const res = await fetch('/api/config');
      if (!res.ok) return;
      const cfg = await res.json();
      hostsInput.value = cfg.hosts || '';
      portInput.value = cfg.port || 9042;
      usernameInput.value = cfg.username || '';
      keyspaceInput.value = cfg.keyspace || '';
      if (cfg.connected) {
        configStatus.textContent = 'Connecté au cluster Cassandra.';
        configStatus.className = 'status success';
      } else {
        configStatus.textContent = 'Non connecté. Veuillez configurer le cluster et tester la connexion.';
        configStatus.className = 'status info';
      }
    } catch (e) {
      console.error(e);
    }
  }

  async function saveConfig() {
    configStatus.textContent = 'Test de connexion en cours...';
    configStatus.className = 'status info';

    const payload = {
      hosts: hostsInput.value || '127.0.0.1',
      port: parseInt(portInput.value || '9042', 10),
      username: usernameInput.value || '',
      password: passwordInput.value || '',
      keyspace: keyspaceInput.value || '',
    };

    try {
      const res = await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        configStatus.textContent = 'Erreur : ' + (err.detail || 'échec de connexion');
        configStatus.className = 'status error';
        return;
      }

      const data = await res.json();
      configStatus.textContent = data.message || 'Connexion réussie.';
      configStatus.className = 'status success';
      // Rafraîchir les métadonnées après connexion
      loadStatus();
      loadKeyspaces();
    } catch (e) {
      console.error(e);
      configStatus.textContent = 'Erreur réseau ou serveur lors du test de connexion.';
      configStatus.className = 'status error';
    }
  }

  function getQueryAtCursor() {
    const text = getEditorValue();
    
    if (codeEditor) {
      // Vérifier d'abord si du texte est sélectionné
      const selection = codeEditor.getSelection();
      if (selection && selection.trim().length > 0) {
        return selection.trim();
      }
      
      // Sinon, trouver la requête à la position du curseur
      const cursor = codeEditor.getCursor();
      const cursorPos = codeEditor.indexFromPos(cursor);
      
      // Chercher le point-virgule précédent
      let queryStart = 0;
      let in_string = false;
      let string_char = null;
      
      for (let i = cursorPos - 1; i >= 0; i--) {
        const char = text[i];
        if ((char === "'" || char === '"') && (i === 0 || text[i-1] !== '\\')) {
          if (!in_string) {
            in_string = true;
            string_char = char;
          } else if (char === string_char) {
            in_string = false;
            string_char = null;
          }
        }
        if (char === ';' && !in_string) {
          queryStart = i + 1;
          break;
        }
      }
      
      // Chercher le point-virgule suivant
      let queryEnd = text.length;
      in_string = false;
      string_char = null;
      
      for (let i = cursorPos; i < text.length; i++) {
        const char = text[i];
        if ((char === "'" || char === '"') && (i === 0 || text[i-1] !== '\\')) {
          if (!in_string) {
            in_string = true;
            string_char = char;
          } else if (char === string_char) {
            in_string = false;
            string_char = null;
          }
        }
        if (char === ';' && !in_string) {
          queryEnd = i;
          break;
        }
      }
      
      return text.substring(queryStart, queryEnd).trim();
    } else {
      // Fallback pour textarea classique
      const start = cqlTextarea.selectionStart;
      const end = cqlTextarea.selectionEnd;
      
      if (start !== end) {
        const selected = text.substring(start, end).trim();
        if (selected.length > 0) {
          return selected;
        }
      }
      
      // Trouver la requête à la position du curseur
      let queryStart = 0;
      let in_string = false;
      let string_char = null;
      
      for (let i = start - 1; i >= 0; i--) {
        const char = text[i];
        if ((char === "'" || char === '"') && (i === 0 || text[i-1] !== '\\')) {
          if (!in_string) {
            in_string = true;
            string_char = char;
          } else if (char === string_char) {
            in_string = false;
            string_char = null;
          }
        }
        if (char === ';' && !in_string) {
          queryStart = i + 1;
          break;
        }
      }
      
      let queryEnd = text.length;
      in_string = false;
      string_char = null;
      
      for (let i = start; i < text.length; i++) {
        const char = text[i];
        if ((char === "'" || char === '"') && (i === 0 || text[i-1] !== '\\')) {
          if (!in_string) {
            in_string = true;
            string_char = char;
          } else if (char === string_char) {
            in_string = false;
            string_char = null;
          }
        }
        if (char === ';' && !in_string) {
          queryEnd = i;
          break;
        }
      }
      
      return text.substring(queryStart, queryEnd).trim();
    }
  }

  async function executeQuery() {
    // Récupérer la requête sélectionnée ou à la position du curseur
    let query = getQueryAtCursor();
    
    // Si aucune requête trouvée, utiliser tout le texte
    if (!query) {
      query = getEditorValue().trim();
    }
    
    statusDiv.textContent = '';
    statusDiv.className = 'status';

    if (!query) {
      statusDiv.textContent = 'Veuillez saisir une requête CQL ou sélectionner une requête.';
      statusDiv.classList.add('error');
      return;
    }

    statusDiv.textContent = 'Exécution en cours...';
    try {
      const response = await fetch('/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query }),
      });

      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        statusDiv.textContent = 'Erreur : ' + (err.detail || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
        return;
      }

      const data = await response.json();

      if (!data.success && data.type !== 'batch') {
        statusDiv.textContent = 'Erreur : ' + (data.error || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
        return;
      }

      // Gestion des résultats batch (plusieurs requêtes)
      if (data.type === 'batch') {
        statusDiv.textContent = `Exécution terminée : ${data.successful} réussie(s), ${data.failed} échouée(s) sur ${data.total_queries} requête(s).`;
        statusDiv.className = data.failed === 0 ? 'status success' : 'status error';
        
        let html = '';
        html += `<div class="batch-result-header">Résultats de ${data.total_queries} requête(s)</div>`;
        
        // Afficher les résultats réussis
        for (const result of data.results) {
          html += `<div class="batch-result success">`;
          html += `<div class="batch-result-header">Requête ${result.query_index}: ${result.query}</div>`;
          if (result.type === 'select') {
            html += `<div>${result.row_count} ligne(s) retournée(s)</div>`;
            html += renderTableHTML(result.columns, result.rows);
          } else {
            html += `<div>${result.message || 'OK'}</div>`;
          }
          html += `</div>`;
        }
        
        // Afficher les erreurs
        for (const error of data.errors) {
          html += `<div class="batch-result error">`;
          html += `<div class="batch-result-header">Requête ${error.query_index}: ${error.query}</div>`;
          html += `<div style="color: #e74c3c;">Erreur : ${error.error}</div>`;
          html += `</div>`;
        }
        
        resultsDiv.innerHTML = html;
        return;
      }

      // Gestion d'une seule requête (comportement original)
      if (!data.success) {
        statusDiv.textContent = 'Erreur : ' + (data.error || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
        return;
      }

      statusDiv.textContent = 'Requête exécutée avec succès.';
      statusDiv.classList.add('success');

      if (data.type === 'select') {
        renderTable(data.columns, data.rows);
      } else {
        resultsDiv.innerHTML = `<div>${data.message || 'OK'}</div>`;
      }

    } catch (err) {
      console.error(err);
      statusDiv.textContent = 'Erreur réseau ou serveur.';
      statusDiv.classList.add('error');
      resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l’exécution.</div>';
    }
  }

  function renderTable(columns, rows) {
    if (!rows || rows.length === 0) {
      resultsDiv.innerHTML = '<div class="results-empty">Aucune ligne retournée.</div>';
      return;
    }

    resultsDiv.innerHTML = renderTableHTML(columns, rows);
  }

  function renderTableHTML(columns, rows) {
    if (!rows || rows.length === 0) {
      return '<div class="results-empty">Aucune ligne retournée.</div>';
    }

    let html = '<table><thead><tr>';
    for (const col of columns) {
      html += `<th>${col}</th>`;
    }
    html += '</tr></thead><tbody>';

    for (const row of rows) {
      html += '<tr>';
      for (const col of columns) {
        let value = row[col];
        if (value === null || value === undefined) {
          value = '';
        } else if (typeof value === 'object') {
          value = JSON.stringify(value);
        }
        // Échapper les caractères HTML pour la sécurité
        value = String(value).replace(/</g, '&lt;').replace(/>/g, '&gt;');
        html += `<td>${value}</td>`;
      }
      html += '</tr>';
    }

    html += '</tbody></table>';
    return html;
  }

  const runAllBtn = document.getElementById('runAllBtn');

  async function executeAllQueries() {
    const query = getEditorValue().trim();
    statusDiv.textContent = '';
    statusDiv.className = 'status';

    if (!query) {
      statusDiv.textContent = 'Veuillez saisir une requête CQL.';
      statusDiv.classList.add('error');
      return;
    }

    statusDiv.textContent = 'Exécution en cours...';
    try {
      const response = await fetch('/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query }),
      });

      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        statusDiv.textContent = 'Erreur : ' + (err.detail || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
        return;
      }

      const data = await response.json();

      if (!data.success && data.type !== 'batch') {
        statusDiv.textContent = 'Erreur : ' + (data.error || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
        return;
      }

      // Gestion des résultats batch (plusieurs requêtes)
      if (data.type === 'batch') {
        statusDiv.textContent = `Exécution terminée : ${data.successful} réussie(s), ${data.failed} échouée(s) sur ${data.total_queries} requête(s).`;
        statusDiv.className = data.failed === 0 ? 'status success' : 'status error';
        
        let html = '';
        html += `<div class="batch-result-header">Résultats de ${data.total_queries} requête(s)</div>`;
        
        // Afficher les résultats réussis
        for (const result of data.results) {
          html += `<div class="batch-result success">`;
          html += `<div class="batch-result-header">Requête ${result.query_index}: ${result.query}</div>`;
          if (result.type === 'select') {
            html += `<div>${result.row_count} ligne(s) retournée(s)</div>`;
            html += renderTableHTML(result.columns, result.rows);
          } else {
            html += `<div>${result.message || 'OK'}</div>`;
          }
          html += `</div>`;
        }
        
        // Afficher les erreurs
        for (const error of data.errors) {
          html += `<div class="batch-result error">`;
          html += `<div class="batch-result-header">Requête ${error.query_index}: ${error.query}</div>`;
          html += `<div style="color: #e74c3c;">Erreur : ${error.error}</div>`;
          html += `</div>`;
        }
        
        resultsDiv.innerHTML = html;
        return;
      }

      // Gestion d'une seule requête (comportement original)
      if (!data.success) {
        statusDiv.textContent = 'Erreur : ' + (data.error || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
        return;
      }

      statusDiv.textContent = 'Requête exécutée avec succès.';
      statusDiv.classList.add('success');

      if (data.type === 'select') {
        renderTable(data.columns, data.rows);
      } else {
        resultsDiv.innerHTML = `<div>${data.message || 'OK'}</div>`;
      }

    } catch (err) {
      console.error(err);
      statusDiv.textContent = 'Erreur réseau ou serveur.';
      statusDiv.classList.add('error');
      resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
    }
  }

  // Fonction d'import de fichier CQL
  const importFileInput = document.getElementById('importFile');
  
  importFileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      const content = event.target.result;
      setEditorValue(content);
      if (codeEditor) {
        codeEditor.refresh();
      }
      statusDiv.textContent = `Fichier "${file.name}" importé avec succès.`;
      statusDiv.className = 'status success';
      
      // Réinitialiser l'input pour permettre de réimporter le même fichier
      importFileInput.value = '';
    };
    
    reader.onerror = function() {
      statusDiv.textContent = 'Erreur lors de la lecture du fichier.';
      statusDiv.className = 'status error';
      importFileInput.value = '';
    };
    
    reader.readAsText(file);
  });

  saveConfigBtn.addEventListener('click', saveConfig);
  runBtn.addEventListener('click', executeQuery);
  runAllBtn.addEventListener('click', executeAllQueries);
  saveQueryBtn.addEventListener('click', saveQuery);

  // Initialiser l'éditeur CodeMirror quand l'onglet éditeur est activé
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const target = tab.getAttribute('data-tab');
      if (target === 'editor' && !codeEditor) {
        // Attendre un peu pour que le DOM soit prêt
        setTimeout(() => {
          initCodeEditor();
        }, 100);
      }
    });
  });

  // Initialiser immédiatement si l'onglet éditeur est déjà actif
  if (tabEditor.style.display !== 'none') {
    setTimeout(() => {
      initCodeEditor();
    }, 100);
  }

  loadConfig();
  loadSavedQueries();
  loadStatus();
  loadKeyspaces();
</script>
</body>
</html>



