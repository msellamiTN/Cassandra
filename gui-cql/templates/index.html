<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Cassandra CQL Web Editor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    header {
      background: #2d3e50;
      color: white;
      padding: 10px 20px;
    }
    h1 {
      margin: 0;
      font-size: 20px;
    }
    main {
      padding: 20px;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 15px;
    }
    .tab {
      padding: 8px 16px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      font-size: 14px;
      background: #ecf0f1;
    }
    .tab.active {
      border-color: #ccc;
      background: #ffffff;
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
    }
    .tab-content {
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 0 4px 4px 4px;
      padding: 15px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 160px;
    }
    label {
      font-size: 13px;
      margin-bottom: 4px;
    }
    input, textarea {
      font-family: "Consolas", "Courier New", monospace;
      font-size: 14px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      min-height: 150px;
      resize: vertical;
    }
    button {
      padding: 8px 16px;
      background: #1abc9c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    button:hover {
      background: #16a085;
    }
    .btn-secondary {
      background: #3498db;
    }
    .btn-secondary:hover {
      background: #2980b9;
    }
    .status {
      margin-top: 10px;
      font-size: 13px;
    }
    .status.error {
      color: #c0392b;
    }
    .status.success {
      color: #27ae60;
    }
    .status.info {
      color: #7f8c8d;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      font-size: 13px;
    }
    th {
      background: #ecf0f1;
      text-align: left;
    }
    .results-container {
      overflow: auto;
      max-height: 400px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background: white;
      padding: 10px;
      box-sizing: border-box;
    }
    .results-empty {
      color: #7f8c8d;
      font-style: italic;
    }
  </style>
</head>
<body>
<header>
  <h1>Cassandra CQL Web Editor</h1>
</header>
<main>
  <div class="tabs">
    <div class="tab active" data-tab="config">Configuration du cluster</div>
    <div class="tab" data-tab="editor">Éditeur CQL</div>
  </div>

  <div id="tab-config" class="tab-content">
    <div class="form-row">
      <div class="form-group">
        <label for="hosts">Hôtes (séparés par des virgules)</label>
        <input id="hosts" type="text" placeholder="127.0.0.1,192.168.0.10" />
      </div>
      <div class="form-group" style="max-width: 120px;">
        <label for="port">Port</label>
        <input id="port" type="number" value="9042" />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="username">Utilisateur (optionnel)</label>
        <input id="username" type="text" />
      </div>
      <div class="form-group">
        <label for="password">Mot de passe (optionnel)</label>
        <input id="password" type="password" />
      </div>
      <div class="form-group">
        <label for="keyspace">Keyspace (optionnel)</label>
        <input id="keyspace" type="text" placeholder="ex: my_keyspace" />
      </div>
    </div>

    <button id="saveConfigBtn" class="btn-secondary">Sauvegarder & Tester la connexion</button>
    <div id="configStatus" class="status info">Aucun test de connexion encore effectué.</div>
  </div>

  <div id="tab-editor" class="tab-content" style="display: none;">
    <section class="editor-container">
      <label for="cql">Requête CQL :</label>
      <textarea id="cql" placeholder="Exemple : SELECT * FROM system.local;"></textarea>
      <button id="runBtn">Exécuter</button>
      <div id="status" class="status"></div>
    </section>

    <section>
      <h2>Résultats</h2>
      <div id="results" class="results-container">
        <div class="results-empty">Aucun résultat pour l’instant.</div>
      </div>
    </section>
  </div>
</main>

<script>
  const tabs = document.querySelectorAll('.tab');
  const tabConfig = document.getElementById('tab-config');
  const tabEditor = document.getElementById('tab-editor');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const target = tab.getAttribute('data-tab');
      if (target === 'config') {
        tabConfig.style.display = 'block';
        tabEditor.style.display = 'none';
      } else {
        tabConfig.style.display = 'none';
        tabEditor.style.display = 'block';
      }
    });
  });

  const hostsInput = document.getElementById('hosts');
  const portInput = document.getElementById('port');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  const keyspaceInput = document.getElementById('keyspace');
  const saveConfigBtn = document.getElementById('saveConfigBtn');
  const configStatus = document.getElementById('configStatus');

  const runBtn = document.getElementById('runBtn');
  const cqlTextarea = document.getElementById('cql');
  const statusDiv = document.getElementById('status');
  const resultsDiv = document.getElementById('results');

  async function loadConfig() {
    try {
      const res = await fetch('/api/config');
      if (!res.ok) return;
      const cfg = await res.json();
      hostsInput.value = cfg.hosts || '';
      portInput.value = cfg.port || 9042;
      usernameInput.value = cfg.username || '';
      keyspaceInput.value = cfg.keyspace || '';
      if (cfg.connected) {
        configStatus.textContent = 'Connecté au cluster Cassandra.';
        configStatus.className = 'status success';
      } else {
        configStatus.textContent = 'Non connecté. Veuillez configurer le cluster et tester la connexion.';
        configStatus.className = 'status info';
      }
    } catch (e) {
      console.error(e);
    }
  }

  async function saveConfig() {
    configStatus.textContent = 'Test de connexion en cours...';
    configStatus.className = 'status info';

    const payload = {
      hosts: hostsInput.value || '127.0.0.1',
      port: parseInt(portInput.value || '9042', 10),
      username: usernameInput.value || '',
      password: passwordInput.value || '',
      keyspace: keyspaceInput.value || '',
    };

    try {
      const res = await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        configStatus.textContent = 'Erreur : ' + (err.detail || 'échec de connexion');
        configStatus.className = 'status error';
        return;
      }

      const data = await res.json();
      configStatus.textContent = data.message || 'Connexion réussie.';
      configStatus.className = 'status success';
    } catch (e) {
      console.error(e);
      configStatus.textContent = 'Erreur réseau ou serveur lors du test de connexion.';
      configStatus.className = 'status error';
    }
  }

  async function executeQuery() {
    const query = cqlTextarea.value.trim();
    statusDiv.textContent = '';
    statusDiv.className = 'status';

    if (!query) {
      statusDiv.textContent = 'Veuillez saisir une requête CQL.';
      statusDiv.classList.add('error');
      return;
    }

    statusDiv.textContent = 'Exécution en cours...';
    try {
      const response = await fetch('/api/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query }),
      });

      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        statusDiv.textContent = 'Erreur : ' + (err.detail || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l’exécution.</div>';
        return;
      }

      const data = await response.json();

      if (!data.success) {
        statusDiv.textContent = 'Erreur : ' + (data.error || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l’exécution.</div>';
        return;
      }

      statusDiv.textContent = 'Requête exécutée avec succès.';
      statusDiv.classList.add('success');

      if (data.type === 'select') {
        renderTable(data.columns, data.rows);
      } else {
        resultsDiv.innerHTML = `<div>${data.message || 'OK'}</div>`;
      }

    } catch (err) {
      console.error(err);
      statusDiv.textContent = 'Erreur réseau ou serveur.';
      statusDiv.classList.add('error');
      resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l’exécution.</div>';
    }
  }

  function renderTable(columns, rows) {
    if (!rows || rows.length === 0) {
      resultsDiv.innerHTML = '<div class="results-empty">Aucune ligne retournée.</div>';
      return;
    }

    let html = '<table><thead><tr>';
    for (const col of columns) {
      html += `<th>${col}</th>`;
    }
    html += '</tr></thead><tbody>';

    for (const row of rows) {
      html += '<tr>';
      for (const col of columns) {
        let value = row[col];
        if (value === null || value === undefined) {
          value = '';
        } else if (typeof value === 'object') {
          value = JSON.stringify(value);
        }
        html += `<td>${value}</td>`;
      }
      html += '</tr>';
    }

    html += '</tbody></table>';
    resultsDiv.innerHTML = html;
  }

  saveConfigBtn.addEventListener('click', saveConfig);
  runBtn.addEventListener('click', executeQuery);
  cqlTextarea.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      executeQuery();
    }
  });

  loadConfig();
</script>
</body>
</html>



