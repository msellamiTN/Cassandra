<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Cassandra CQL Web Editor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    header {
      background: #2d3e50;
      color: white;
      padding: 10px 20px;
    }
    h1 {
      margin: 0;
      font-size: 20px;
    }
    main {
      padding: 20px;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 15px;
    }
    .tab {
      padding: 8px 16px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      font-size: 14px;
      background: #ecf0f1;
    }
    .tab.active {
      border-color: #ccc;
      background: #ffffff;
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
    }
    .tab-content {
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 0 4px 4px 4px;
      padding: 15px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 160px;
    }
    label {
      font-size: 13px;
      margin-bottom: 4px;
    }
    input, textarea {
      font-family: "Consolas", "Courier New", monospace;
      font-size: 14px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      min-height: 150px;
      resize: vertical;
    }
    button {
      padding: 8px 16px;
      background: #1abc9c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    button:hover {
      background: #16a085;
    }
    .btn-secondary {
      background: #3498db;
    }
    .btn-secondary:hover {
      background: #2980b9;
    }
    .status {
      margin-top: 10px;
      font-size: 13px;
    }
    .status.error {
      color: #c0392b;
    }
    .status.success {
      color: #27ae60;
    }
    .status.info {
      color: #7f8c8d;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      font-size: 13px;
    }
    th {
      background: #ecf0f1;
      text-align: left;
    }
    .results-container {
      overflow: auto;
      max-height: 400px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background: white;
      padding: 10px;
      box-sizing: border-box;
    }
    .results-empty {
      color: #7f8c8d;
      font-style: italic;
    }
    .query-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .saved-queries {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
    }
    .saved-queries-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      background: #f9f9f9;
      margin-top: 8px;
    }
    .saved-query-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      margin-bottom: 4px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 3px;
      cursor: pointer;
    }
    .saved-query-item:hover {
      background: #f0f0f0;
    }
    .saved-query-item.active {
      background: #e3f2fd;
      border-color: #3498db;
    }
    .saved-query-name {
      flex: 1;
      font-weight: bold;
      font-size: 13px;
    }
    .saved-query-preview {
      flex: 2;
      font-size: 12px;
      color: #666;
      margin: 0 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .saved-query-actions {
      display: flex;
      gap: 5px;
    }
    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
    }
    .btn-danger {
      background: #e74c3c;
    }
    .btn-danger:hover {
      background: #c0392b;
    }
    .batch-result {
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f9f9f9;
    }
    .batch-result-header {
      font-weight: bold;
      margin-bottom: 8px;
      color: #2d3e50;
    }
    .batch-result.success {
      border-left: 4px solid #27ae60;
    }
    .batch-result.error {
      border-left: 4px solid #e74c3c;
    }
    .query-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .query-input-group input {
      flex: 1;
    }
  </style>
</head>
<body>
<header>
  <h1>Cassandra CQL Web Editor</h1>
</header>
<main>
  <div class="tabs">
    <div class="tab active" data-tab="config">Configuration du cluster</div>
    <div class="tab" data-tab="editor">Éditeur CQL</div>
  </div>

  <div id="tab-config" class="tab-content">
    <div class="form-row">
      <div class="form-group">
        <label for="hosts">Hôtes (séparés par des virgules)</label>
        <input id="hosts" type="text" placeholder="127.0.0.1,192.168.0.10" />
      </div>
      <div class="form-group" style="max-width: 120px;">
        <label for="port">Port</label>
        <input id="port" type="number" value="9042" />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="username">Utilisateur (optionnel)</label>
        <input id="username" type="text" />
      </div>
      <div class="form-group">
        <label for="password">Mot de passe (optionnel)</label>
        <input id="password" type="password" />
      </div>
      <div class="form-group">
        <label for="keyspace">Keyspace (optionnel)</label>
        <input id="keyspace" type="text" placeholder="ex: my_keyspace" />
      </div>
    </div>

    <button id="saveConfigBtn" class="btn-secondary">Sauvegarder & Tester la connexion</button>
    <div id="configStatus" class="status info">Aucun test de connexion encore effectué.</div>
  </div>

  <div id="tab-editor" class="tab-content" style="display: none;">
    <section class="editor-container">
      <label for="cql">Requête(s) CQL (séparées par des points-virgules) :</label>
      <textarea id="cql" placeholder="Exemple : SELECT * FROM system.local;&#10;SELECT * FROM system.peers;"></textarea>
      <div class="query-actions">
        <button id="runBtn">Exécuter</button>
        <div class="query-input-group">
          <input type="text" id="queryName" placeholder="Nom de la requête..." />
          <button id="saveQueryBtn" class="btn-secondary btn-small">Sauvegarder</button>
        </div>
      </div>
      <div id="status" class="status"></div>
    </section>

    <section class="saved-queries">
      <h3>Requêtes sauvegardées</h3>
      <div id="savedQueriesList" class="saved-queries-list">
        <div class="results-empty">Aucune requête sauvegardée.</div>
      </div>
    </section>

    <section>
      <h2>Résultats</h2>
      <div id="results" class="results-container">
        <div class="results-empty">Aucun résultat pour l'instant.</div>
      </div>
    </section>
  </div>
</main>

<script>
  const tabs = document.querySelectorAll('.tab');
  const tabConfig = document.getElementById('tab-config');
  const tabEditor = document.getElementById('tab-editor');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const target = tab.getAttribute('data-tab');
      if (target === 'config') {
        tabConfig.style.display = 'block';
        tabEditor.style.display = 'none';
      } else {
        tabConfig.style.display = 'none';
        tabEditor.style.display = 'block';
      }
    });
  });

  const hostsInput = document.getElementById('hosts');
  const portInput = document.getElementById('port');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  const keyspaceInput = document.getElementById('keyspace');
  const saveConfigBtn = document.getElementById('saveConfigBtn');
  const configStatus = document.getElementById('configStatus');

  const runBtn = document.getElementById('runBtn');
  const cqlTextarea = document.getElementById('cql');
  const statusDiv = document.getElementById('status');
  const resultsDiv = document.getElementById('results');
  const saveQueryBtn = document.getElementById('saveQueryBtn');
  const queryNameInput = document.getElementById('queryName');
  const savedQueriesList = document.getElementById('savedQueriesList');

  // Gestion des requêtes sauvegardées
  const STORAGE_KEY = 'cql_saved_queries';

  function getSavedQueries() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : {};
    } catch (e) {
      return {};
    }
  }

  function saveQueries(queries) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(queries));
    } catch (e) {
      console.error('Erreur lors de la sauvegarde:', e);
    }
  }

  function loadSavedQueries() {
    const queries = getSavedQueries();
    const keys = Object.keys(queries);
    
    if (keys.length === 0) {
      savedQueriesList.innerHTML = '<div class="results-empty">Aucune requête sauvegardée.</div>';
      return;
    }

    let html = '';
    for (const name of keys.sort()) {
      const query = queries[name];
      const preview = query.length > 50 ? query.substring(0, 50) + '...' : query;
      html += `
        <div class="saved-query-item" data-name="${name}">
          <div class="saved-query-name">${name}</div>
          <div class="saved-query-preview">${preview.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
          <div class="saved-query-actions">
            <button class="btn-secondary btn-small load-query-btn" data-name="${name}">Charger</button>
            <button class="btn-danger btn-small delete-query-btn" data-name="${name}">Supprimer</button>
          </div>
        </div>
      `;
    }
    savedQueriesList.innerHTML = html;

    // Ajouter les event listeners
    document.querySelectorAll('.load-query-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const name = e.target.getAttribute('data-name');
        loadQuery(name);
      });
    });

    document.querySelectorAll('.delete-query-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const name = e.target.getAttribute('data-name');
        deleteQuery(name);
      });
    });
  }

  function saveQuery() {
    const query = cqlTextarea.value.trim();
    const name = queryNameInput.value.trim();

    if (!query) {
      alert('Veuillez saisir une requête à sauvegarder.');
      return;
    }

    if (!name) {
      alert('Veuillez donner un nom à cette requête.');
      return;
    }

    const queries = getSavedQueries();
    queries[name] = query;
    saveQueries(queries);
    loadSavedQueries();
    queryNameInput.value = '';
    
    statusDiv.textContent = `Requête "${name}" sauvegardée.`;
    statusDiv.className = 'status success';
  }

  function loadQuery(name) {
    const queries = getSavedQueries();
    if (queries[name]) {
      cqlTextarea.value = queries[name];
      queryNameInput.value = name;
      statusDiv.textContent = `Requête "${name}" chargée.`;
      statusDiv.className = 'status success';
    }
  }

  function deleteQuery(name) {
    if (!confirm(`Supprimer la requête "${name}" ?`)) {
      return;
    }

    const queries = getSavedQueries();
    delete queries[name];
    saveQueries(queries);
    loadSavedQueries();
    
    statusDiv.textContent = `Requête "${name}" supprimée.`;
    statusDiv.className = 'status info';
  }

  async function loadConfig() {
    try {
      const res = await fetch('/api/config');
      if (!res.ok) return;
      const cfg = await res.json();
      hostsInput.value = cfg.hosts || '';
      portInput.value = cfg.port || 9042;
      usernameInput.value = cfg.username || '';
      keyspaceInput.value = cfg.keyspace || '';
      if (cfg.connected) {
        configStatus.textContent = 'Connecté au cluster Cassandra.';
        configStatus.className = 'status success';
      } else {
        configStatus.textContent = 'Non connecté. Veuillez configurer le cluster et tester la connexion.';
        configStatus.className = 'status info';
      }
    } catch (e) {
      console.error(e);
    }
  }

  async function saveConfig() {
    configStatus.textContent = 'Test de connexion en cours...';
    configStatus.className = 'status info';

    const payload = {
      hosts: hostsInput.value || '127.0.0.1',
      port: parseInt(portInput.value || '9042', 10),
      username: usernameInput.value || '',
      password: passwordInput.value || '',
      keyspace: keyspaceInput.value || '',
    };

    try {
      const res = await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        configStatus.textContent = 'Erreur : ' + (err.detail || 'échec de connexion');
        configStatus.className = 'status error';
        return;
      }

      const data = await res.json();
      configStatus.textContent = data.message || 'Connexion réussie.';
      configStatus.className = 'status success';
    } catch (e) {
      console.error(e);
      configStatus.textContent = 'Erreur réseau ou serveur lors du test de connexion.';
      configStatus.className = 'status error';
    }
  }

  async function executeQuery() {
    const query = cqlTextarea.value.trim();
    statusDiv.textContent = '';
    statusDiv.className = 'status';

    if (!query) {
      statusDiv.textContent = 'Veuillez saisir une requête CQL.';
      statusDiv.classList.add('error');
      return;
    }

    statusDiv.textContent = 'Exécution en cours...';
    try {
      const response = await fetch('/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query }),
      });

      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        statusDiv.textContent = 'Erreur : ' + (err.detail || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
        return;
      }

      const data = await response.json();

      if (!data.success && data.type !== 'batch') {
        statusDiv.textContent = 'Erreur : ' + (data.error || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
        return;
      }

      // Gestion des résultats batch (plusieurs requêtes)
      if (data.type === 'batch') {
        statusDiv.textContent = `Exécution terminée : ${data.successful} réussie(s), ${data.failed} échouée(s) sur ${data.total_queries} requête(s).`;
        statusDiv.className = data.failed === 0 ? 'status success' : 'status error';
        
        let html = '';
        html += `<div class="batch-result-header">Résultats de ${data.total_queries} requête(s)</div>`;
        
        // Afficher les résultats réussis
        for (const result of data.results) {
          html += `<div class="batch-result success">`;
          html += `<div class="batch-result-header">Requête ${result.query_index}: ${result.query}</div>`;
          if (result.type === 'select') {
            html += `<div>${result.row_count} ligne(s) retournée(s)</div>`;
            html += renderTableHTML(result.columns, result.rows);
          } else {
            html += `<div>${result.message || 'OK'}</div>`;
          }
          html += `</div>`;
        }
        
        // Afficher les erreurs
        for (const error of data.errors) {
          html += `<div class="batch-result error">`;
          html += `<div class="batch-result-header">Requête ${error.query_index}: ${error.query}</div>`;
          html += `<div style="color: #e74c3c;">Erreur : ${error.error}</div>`;
          html += `</div>`;
        }
        
        resultsDiv.innerHTML = html;
        return;
      }

      // Gestion d'une seule requête (comportement original)
      if (!data.success) {
        statusDiv.textContent = 'Erreur : ' + (data.error || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
        return;
      }

      statusDiv.textContent = 'Requête exécutée avec succès.';
      statusDiv.classList.add('success');

      if (data.type === 'select') {
        renderTable(data.columns, data.rows);
      } else {
        resultsDiv.innerHTML = `<div>${data.message || 'OK'}</div>`;
      }

    } catch (err) {
      console.error(err);
      statusDiv.textContent = 'Erreur réseau ou serveur.';
      statusDiv.classList.add('error');
      resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l’exécution.</div>';
    }
  }

  function renderTable(columns, rows) {
    if (!rows || rows.length === 0) {
      resultsDiv.innerHTML = '<div class="results-empty">Aucune ligne retournée.</div>';
      return;
    }

    resultsDiv.innerHTML = renderTableHTML(columns, rows);
  }

  function renderTableHTML(columns, rows) {
    if (!rows || rows.length === 0) {
      return '<div class="results-empty">Aucune ligne retournée.</div>';
    }

    let html = '<table><thead><tr>';
    for (const col of columns) {
      html += `<th>${col}</th>`;
    }
    html += '</tr></thead><tbody>';

    for (const row of rows) {
      html += '<tr>';
      for (const col of columns) {
        let value = row[col];
        if (value === null || value === undefined) {
          value = '';
        } else if (typeof value === 'object') {
          value = JSON.stringify(value);
        }
        // Échapper les caractères HTML pour la sécurité
        value = String(value).replace(/</g, '&lt;').replace(/>/g, '&gt;');
        html += `<td>${value}</td>`;
      }
      html += '</tr>';
    }

    html += '</tbody></table>';
    return html;
  }

  saveConfigBtn.addEventListener('click', saveConfig);
  runBtn.addEventListener('click', executeQuery);
  saveQueryBtn.addEventListener('click', saveQuery);
  cqlTextarea.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      executeQuery();
    }
  });

  loadConfig();
  loadSavedQueries();
</script>
</body>
</html>



