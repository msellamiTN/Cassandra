<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Cassandra CQL Web Editor</title>
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    header {
      background: #2d3e50;
      color: white;
      padding: 10px 20px;
    }
    h1 {
      margin: 0;
      font-size: 20px;
    }
    main {
      padding: 20px;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 15px;
    }
    .tab {
      padding: 8px 16px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      font-size: 14px;
      background: #ecf0f1;
    }
    .tab.active {
      border-color: #ccc;
      background: #ffffff;
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
    }
    .tab-content {
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 0 4px 4px 4px;
      padding: 15px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 160px;
    }
    label {
      font-size: 13px;
      margin-bottom: 4px;
    }
    input, textarea {
      font-family: "Consolas", "Courier New", monospace;
      font-size: 14px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      min-height: 150px;
      resize: vertical;
    }
    /* CodeMirror Editor Styles */
    .CodeMirror {
      font-family: "Fira Code", "Consolas", "Monaco", "Courier New", monospace;
      font-size: 14px;
      line-height: 1.5;
      border: 1px solid #ccc;
      border-radius: 4px;
      height: auto;
      min-height: 300px;
    }
    .CodeMirror-scroll {
      min-height: 300px;
      max-height: 600px;
    }
    .CodeMirror-gutters {
      border-right: 1px solid #ddd;
      background-color: #f7f7f7;
    }
    /* Comment styling - vert avec style italique */
    .CodeMirror .cm-comment {
      color: #6a9955 !important;
      font-style: italic !important;
      background-color: rgba(106, 153, 85, 0.1);
    }
    /* SQL Keywords - bleu avec gras */
    .CodeMirror .cm-keyword {
      color: #569cd6 !important;
      font-weight: bold !important;
    }
    /* Strings - orange/rouge */
    .CodeMirror .cm-string {
      color: #ce9178 !important;
    }
    /* Numbers - vert clair */
    .CodeMirror .cm-number {
      color: #b5cea8 !important;
    }
    /* Operators */
    .CodeMirror .cm-operator {
      color: #d4d4d4 !important;
    }
    /* Built-in functions */
    .CodeMirror .cm-builtin {
      color: #4ec9b0 !important;
    }
    /* Variables/identifiers */
    .CodeMirror .cm-variable {
      color: #9cdcfe !important;
    }
    /* Property names */
    .CodeMirror .cm-property {
      color: #9cdcfe !important;
    }
    /* Editor container */
    .editor-wrapper {
      position: relative;
      margin-bottom: 10px;
    }
    .editor-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .font-size-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .font-size-control label {
      font-size: 12px;
      margin: 0;
    }
    .font-size-control input[type="range"] {
      width: 100px;
    }
    .font-size-display {
      font-size: 12px;
      color: #666;
      min-width: 40px;
    }
    button {
      padding: 8px 16px;
      background: #1abc9c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    button:hover {
      background: #16a085;
    }
    .btn-secondary {
      background: #3498db;
    }
    .btn-secondary:hover {
      background: #2980b9;
    }
    .status {
      margin-top: 10px;
      font-size: 13px;
    }
    .status.error {
      color: #c0392b;
    }
    .status.success {
      color: #27ae60;
    }
    .status.info {
      color: #7f8c8d;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      font-size: 13px;
    }
    th {
      background: #ecf0f1;
      text-align: left;
    }
    .results-container {
      overflow: auto;
      max-height: 400px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background: white;
      padding: 10px;
      box-sizing: border-box;
    }
    .results-empty {
      color: #7f8c8d;
      font-style: italic;
    }
    .query-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .saved-queries {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
    }
    .saved-queries-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      background: #f9f9f9;
      margin-top: 8px;
    }
    .saved-query-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      margin-bottom: 4px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 3px;
      cursor: pointer;
    }
    .saved-query-item:hover {
      background: #f0f0f0;
    }
    .saved-query-item.active {
      background: #e3f2fd;
      border-color: #3498db;
    }
    .saved-query-name {
      flex: 1;
      font-weight: bold;
      font-size: 13px;
    }
    .saved-query-preview {
      flex: 2;
      font-size: 12px;
      color: #666;
      margin: 0 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .saved-query-actions {
      display: flex;
      gap: 5px;
    }
    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
    }
    .btn-danger {
      background: #e74c3c;
    }
    .btn-danger:hover {
      background: #c0392b;
    }
    /* Query Tabs Styles */
    .query-tabs-container {
      margin-bottom: 15px;
    }
    .query-tabs-header {
      display: flex;
      align-items: center;
      border-bottom: 1px solid #ccc;
      margin-bottom: 10px;
    }
    .query-tabs {
      display: flex;
      flex: 1;
      overflow-x: auto;
    }
    .query-tab {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      background: #ecf0f1;
      margin-right: 2px;
      min-width: 100px;
      position: relative;
    }
    .query-tab.active {
      border-color: #ccc;
      background: #ffffff;
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
    }
    .query-tab-title {
      flex: 1;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .query-tab-close {
      margin-left: 8px;
      color: #999;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      padding: 0 4px;
    }
    .query-tab-close:hover {
      color: #e74c3c;
    }
    .query-tab-content {
      display: none;
    }
    .query-tab-content.active {
      display: block;
    }
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    .file-input-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #95a5a6;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
    }
    .file-input-label:hover {
      background: #7f8c8d;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    .batch-result {
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f9f9f9;
    }
    .batch-result-header {
      font-weight: bold;
      margin-bottom: 8px;
      color: #2d3e50;
    }
    .batch-result.success {
      border-left: 4px solid #27ae60;
    }
    .batch-result.error {
      border-left: 4px solid #e74c3c;
    }
    .query-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .query-input-group input {
      flex: 1;
    }
    /* Layout avec barre latérale */
    .editor-layout {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }
    .editor-main {
      flex: 1 1 0;
      min-width: 0;
    }
    .sidebar {
      width: 320px;
      background: #ffffff;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      position: sticky;
      top: 12px;
      max-height: 85vh;
      overflow: auto;
    }
    .sidebar-section {
      margin-bottom: 12px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .sidebar-section:last-child {
      border-bottom: none;
      padding-bottom: 0;
      margin-bottom: 0;
    }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .sidebar-header h3 {
      margin: 0;
      font-size: 14px;
      color: #2d3e50;
    }
    .sidebar-body {
      font-size: 13px;
      color: #444;
      line-height: 1.4;
    }
    .meta-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 180px;
      overflow-y: auto;
    }
    .meta-item {
      padding: 8px;
      border: 1px solid #e1e4e8;
      border-radius: 4px;
      cursor: pointer;
      background: #fafafa;
      transition: background 0.15s, border-color 0.15s;
    }
    .meta-item:hover {
      background: #f0f6ff;
      border-color: #bcd3ff;
    }
    .meta-item.active {
      background: #e6f0ff;
      border-color: #7da6ff;
    }
    .meta-item-title {
      font-weight: 600;
      color: #2d3e50;
      margin-bottom: 2px;
    }
    .meta-item-sub {
      font-size: 12px;
      color: #666;
    }
    .meta-empty {
      font-size: 12px;
      color: #888;
      font-style: italic;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 11px;
      background: #e9f5ff;
      color: #1b6fbf;
      margin-left: 6px;
    }
    /* Icônes */
    .icon {
      margin-right: 6px;
      width: 14px;
      text-align: center;
      display: inline-block;
    }
    .icon-success {
      color: #27ae60;
    }
    .icon-error {
      color: #e74c3c;
    }
    .icon-info {
      color: #3498db;
    }
    .icon-warning {
      color: #f39c12;
    }
    /* Import file button */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    .file-input-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #3498db;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.2s;
    }
    .file-input-label:hover {
      background: #2980b9;
    }
    .file-input-label i {
      font-size: 12px;
    }
  </style>
  <!-- CodeMirror JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>
</head>
<body>
<header>
  <h1>Cassandra CQL Web Editor</h1>
</header>
<main>
  <div class="tabs">
    <div class="tab active" data-tab="config">Configuration du cluster</div>
    <div class="tab" data-tab="editor">Éditeur CQL</div>
  </div>

  <div id="tab-config" class="tab-content">
    <div class="form-row">
      <div class="form-group">
        <label for="hosts">Hôtes (séparés par des virgules)</label>
        <input id="hosts" type="text" placeholder="127.0.0.1,192.168.0.10" />
      </div>
      <div class="form-group" style="max-width: 120px;">
        <label for="port">Port</label>
        <input id="port" type="number" value="9042" />
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="username">Utilisateur (optionnel)</label>
        <input id="username" type="text" />
      </div>
      <div class="form-group">
        <label for="password">Mot de passe (optionnel)</label>
        <input id="password" type="password" />
      </div>
      <div class="form-group">
        <label for="keyspace">Keyspace (optionnel)</label>
        <input id="keyspace" type="text" placeholder="ex: my_keyspace" />
      </div>
    </div>

    <button id="saveConfigBtn" class="btn-secondary">Sauvegarder & Tester la connexion</button>
    <div id="configStatus" class="status info">Aucun test de connexion encore effectué.</div>
  </div>

  <div id="tab-editor" class="tab-content" style="display: none;">
    <!-- Query Tabs -->
    <div class="query-tabs-container">
      <div class="query-tabs-header">
        <div class="query-tabs">
          <div class="query-tab active" data-query-tab="0">
            <span class="query-tab-title">Query 1</span>
            <span class="query-tab-close" onclick="closeQueryTab(0, event)">×</span>
          </div>
        </div>
        <button id="addQueryTabBtn" class="btn-secondary btn-small" title="Nouvel onglet">
          <i class="fas fa-plus"></i>
        </button>
      </div>
      <div class="query-tab-content active" data-query-tab="0">
        <div class="editor-layout">
          <div class="editor-main">
            <section class="editor-container">
              <div class="editor-controls">
                <label for="cql-0" style="flex: 1;">Requête(s) CQL (séparées par des points-virgules, commentaires avec -- ou /* */) :</label>
                <div class="font-size-control">
                  <label for="fontSize-0">Taille :</label>
                  <input type="range" id="fontSize-0" min="10" max="20" value="14" step="1" />
                  <span class="font-size-display" id="fontSizeDisplay-0">14px</span>
                </div>
              </div>
              <div class="editor-wrapper">
                <textarea id="cql-0" placeholder="Exemple : SELECT * FROM system.local;&#10;SELECT * FROM system.peers;&#10;&#10;Astuce : Sélectionnez une requête ou placez le curseur sur une requête pour l'exécuter seule.&#10;Les commentaires (-- et /* */) sont automatiquement ignorés."></textarea>
              </div>
              <div id="queryPreview-0" class="status info" style="display: none; margin-top: 5px; font-size: 12px; font-style: italic;"></div>
              <div class="query-actions">
                <button id="runBtn-0" onclick="executeQuery(0)"><i class="fas fa-play icon"></i>Exécuter (sélection/cursor)</button>
                <button id="runAllBtn-0" onclick="executeAllQueries(0)" class="btn-secondary"><i class="fas fa-forward icon"></i>Exécuter tout</button>
                <div class="file-input-wrapper">
                  <input type="file" id="importFile-0" accept=".cql,.sql,.txt" onchange="importFile(0)" />
                  <label for="importFile-0" class="file-input-label">
                    <i class="fas fa-file-import"></i>Importer CQL
                  </label>
                </div>
                <div class="query-input-group">
                  <input type="text" id="queryName-0" placeholder="Nom de la requête..." />
                  <button id="saveQueryBtn-0" onclick="saveCurrentQuery(0)" class="btn-secondary btn-small"><i class="fas fa-save icon"></i>Sauvegarder</button>
                </div>
              </div>
              <div id="status-0" class="status"></div>
            </section>

            <section class="saved-queries">
              <h3>Requêtes sauvegardées</h3>
              <div id="savedQueriesList-0" class="saved-queries-list">
                <div class="results-empty">Aucune requête sauvegardée.</div>
              </div>
            </section>

            <section>
              <h2>Résultats</h2>
              <div id="results-0" class="results-container">
                <div class="results-empty">Aucun résultat pour l'instant.</div>
              </div>
            </section>
          </div>

          <aside class="sidebar">
            <div class="sidebar-section">
              <div class="sidebar-header">
                <h3><i class="fas fa-server icon"></i>Statut serveur</h3>
                <button id="refreshStatusBtn" class="btn-secondary btn-small"><i class="fas fa-sync-alt icon"></i>Rafraîchir</button>
              </div>
              <div id="serverStatus" class="sidebar-body meta-empty"><i class="fas fa-times-circle icon icon-error"></i>Non connecté.</div>
            </div>

            <div class="sidebar-section">
              <div class="sidebar-header">
                <h3><i class="fas fa-database icon"></i>Keyspaces</h3>
                <button id="refreshMetaBtn" class="btn-secondary btn-small"><i class="fas fa-sync-alt icon"></i>Rafraîchir</button>
              </div>
              <div id="keyspaceList" class="meta-list">
                <div class="meta-empty"><i class="fas fa-info-circle icon"></i>Aucun keyspace chargé.</div>
              </div>
            </div>

            <div class="sidebar-section">
              <div class="sidebar-header">
                <h3><i class="fas fa-table icon"></i>Tables</h3>
              </div>
              <div id="tableList" class="meta-list">
                <div class="meta-empty"><i class="fas fa-info-circle icon"></i>Aucune table.</div>
              </div>
            </div>

            <div class="sidebar-section">
              <div class="sidebar-header">
                <h3><i class="fas fa-info-circle icon"></i>Détails</h3>
              </div>
              <div id="tableDetails" class="sidebar-body meta-empty"><i class="fas fa-mouse-pointer icon"></i>Sélectionnez une table.</div>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  // Global variables
  const tabs = document.querySelectorAll('.tab');
  const tabConfig = document.getElementById('tab-config');
  const tabEditor = document.getElementById('tab-editor');

  // Query tabs management
  let queryTabs = [];
  let activeQueryTab = 0;
  let tabCounter = 1;

  // Main tab switching (Config/Editor)
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const target = tab.getAttribute('data-tab');
      if (target === 'config') {
        tabConfig.style.display = 'block';
        tabEditor.style.display = 'none';
      } else {
        tabConfig.style.display = 'none';
        tabEditor.style.display = 'block';
      }
    });
  });

  // Configuration elements
  const hostsInput = document.getElementById('hosts');
  const portInput = document.getElementById('port');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  const keyspaceInput = document.getElementById('keyspace');
  const saveConfigBtn = document.getElementById('saveConfigBtn');
  const configStatus = document.getElementById('configStatus');

  // Sidebar elements
  const serverStatusDiv = document.getElementById('serverStatus');
  const keyspaceListDiv = document.getElementById('keyspaceList');
  const tableListDiv = document.getElementById('tableList');
  const tableDetailsDiv = document.getElementById('tableDetails');
  const refreshStatusBtn = document.getElementById('refreshStatusBtn');
  const refreshMetaBtn = document.getElementById('refreshMetaBtn');

  let selectedKeyspace = null;
  let selectedTable = null;

  // Initialize the application
  document.addEventListener('DOMContentLoaded', function() {
    initQueryTabs();
    loadConfig();
    initEventListeners();
  });

  // Initialize query tabs system
  function initQueryTabs() {
    queryTabs = [{
      id: 0,
      title: 'Query 1',
      editor: null,
      content: ''
    }];
    createQueryTabElement(0);
    switchToQueryTab(0);
  }

  // Create a query tab element
  function createQueryTabElement(tabId) {
    const tab = queryTabs.find(t => t.id === tabId);
    if (!tab) return;

    const tabsContainer = document.querySelector('.query-tabs');
    const tabElement = document.createElement('div');
    tabElement.className = 'query-tab';
    tabElement.setAttribute('data-query-tab', tabId);
    tabElement.innerHTML = `
      <span class="query-tab-title">${tab.title}</span>
      <span class="query-tab-close" onclick="closeQueryTab(${tabId}, event)">×</span>
    `;
    tabElement.addEventListener('click', () => switchToQueryTab(tabId));
    tabsContainer.appendChild(tabElement);

    // Create tab content
    const contentElement = document.createElement('div');
    contentElement.className = 'query-tab-content';
    contentElement.setAttribute('data-query-tab', tabId);
    contentElement.innerHTML = `
      <div class="editor-layout">
        <div class="editor-main">
          <section class="editor-container">
            <div class="editor-controls">
              <label for="cql-${tabId}" style="flex: 1;">Requête(s) CQL (séparées par des points-virgules, commentaires avec -- ou /* */) :</label>
              <div class="font-size-control">
                <label for="fontSize-${tabId}">Taille :</label>
                <input type="range" id="fontSize-${tabId}" min="10" max="20" value="14" step="1" />
                <span class="font-size-display" id="fontSizeDisplay-${tabId}">14px</span>
              </div>
            </div>
            <div class="editor-wrapper">
              <textarea id="cql-${tabId}" placeholder="Exemple : SELECT * FROM system.local;&#10;SELECT * FROM system.peers;&#10;&#10;Astuce : Sélectionnez une requête ou placez le curseur sur une requête pour l'exécuter seule.&#10;Les commentaires (-- et /* */) sont automatiquement ignorés.">${tab.content}</textarea>
            </div>
            <div id="queryPreview-${tabId}" class="status info" style="display: none; margin-top: 5px; font-size: 12px; font-style: italic;"></div>
            <div class="query-actions">
              <button id="runBtn-${tabId}" onclick="executeQuery(${tabId})"><i class="fas fa-play icon"></i>Exécuter (sélection/cursor)</button>
              <button id="runAllBtn-${tabId}" onclick="executeAllQueries(${tabId})" class="btn-secondary"><i class="fas fa-forward icon"></i>Exécuter tout</button>
              <div class="file-input-wrapper">
                <input type="file" id="importFile-${tabId}" accept=".cql,.sql,.txt" onchange="importFile(${tabId})" />
                <label for="importFile-${tabId}" class="file-input-label">
                  <i class="fas fa-file-import"></i>Importer CQL
                </label>
              </div>
              <div class="query-input-group">
                <input type="text" id="queryName-${tabId}" placeholder="Nom de la requête..." />
                <button id="saveQueryBtn-${tabId}" onclick="saveCurrentQuery(${tabId})" class="btn-secondary btn-small"><i class="fas fa-save icon"></i>Sauvegarder</button>
              </div>
            </div>
            <div id="status-${tabId}" class="status"></div>
          </section>

          <section class="saved-queries">
            <h3>Requêtes sauvegardées</h3>
            <div id="savedQueriesList-${tabId}" class="saved-queries-list">
              <div class="results-empty">Aucune requête sauvegardée.</div>
            </div>
          </section>

          <section>
            <h2>Résultats</h2>
            <div id="results-${tabId}" class="results-container">
              <div class="results-empty">Aucun résultat pour l'instant.</div>
            </div>
          </section>
        </div>

        <aside class="sidebar">
          <div class="sidebar-section">
            <div class="sidebar-header">
              <h3><i class="fas fa-server icon"></i>Statut serveur</h3>
              <button id="refreshStatusBtn" class="btn-secondary btn-small"><i class="fas fa-sync-alt icon"></i>Rafraîchir</button>
            </div>
            <div id="serverStatus" class="sidebar-body meta-empty"><i class="fas fa-times-circle icon icon-error"></i>Non connecté.</div>
          </div>

          <div class="sidebar-section">
            <div class="sidebar-header">
              <h3><i class="fas fa-database icon"></i>Keyspaces</h3>
              <button id="refreshMetaBtn" class="btn-secondary btn-small"><i class="fas fa-sync-alt icon"></i>Rafraîchir</button>
            </div>
            <div id="keyspaceList" class="meta-list">
              <div class="meta-empty"><i class="fas fa-info-circle icon"></i>Aucun keyspace chargé.</div>
            </div>
          </div>

          <div class="sidebar-section">
            <div class="sidebar-header">
              <h3><i class="fas fa-table icon"></i>Tables</h3>
            </div>
            <div id="tableList" class="meta-list">
              <div class="meta-empty"><i class="fas fa-info-circle icon"></i>Aucune table.</div>
            </div>
          </div>

          <div class="sidebar-section">
            <div class="sidebar-header">
              <h3><i class="fas fa-info-circle icon"></i>Détails</h3>
            </div>
            <div id="tableDetails" class="sidebar-body meta-empty"><i class="fas fa-mouse-pointer icon"></i>Sélectionnez une table.</div>
          </div>
        </aside>
      </div>
    `;

    const tabsContainerDiv = document.querySelector('.query-tabs-container');
    tabsContainerDiv.appendChild(contentElement);

    // Initialize CodeMirror for this tab
    initCodeEditorForTab(tabId);
  }

  // Initialize CodeMirror for a specific tab
  function initCodeEditorForTab(tabId) {
    const textarea = document.getElementById(`cql-${tabId}`);
    const tab = queryTabs.find(t => t.id === tabId);
    if (!textarea || !tab) return;

    const editor = CodeMirror.fromTextArea(textarea, {
      mode: {
        name: 'sql',
        keywords: {
          all: true, alter: true, and: true, any: true, as: true, asc: true,
          authorize: true, batch: true, begin: true, by: true, called: true,
          cluster: true, columnfamily: true, compact: true, consistency: true,
          count: true, create: true, delete: true, desc: true, describe: true,
          distinct: true, drop: true, each_quorum: true, from: true, full: true,
          grant: true, if: true, in: true, index: true, infile: true, insert: true,
          into: true, is: true, keyspace: true, keyspaces: true, level: true,
          limit: true, local_quorum: true, materialized: true, modify: true,
          no: true, not: true, null: true, of: true, on: true, one: true,
          or: true, order: true, password: true, primary: true, quorum: true,
          rename: true, revoke: true, schema: true, select: true, set: true,
          sstable: true, table: true, three: true, to: true, token: true,
          truncate: true, two: true, unlogged: true, update: true, use: true,
          using: true, view: true, where: true, with: true
        }
      },
      theme: 'default',
      lineNumbers: true,
      lineWrapping: true,
      indentWithTabs: false,
      indentUnit: 2,
      matchBrackets: true,
      autoCloseBrackets: true,
      styleActiveLine: true,
      extraKeys: {
        "Ctrl-Enter": function() { executeQuery(tabId); },
        "Cmd-Enter": function() { executeQuery(tabId); }
      }
    });

    tab.editor = editor;

    // Font size control
    const fontSizeControl = document.getElementById(`fontSize-${tabId}`);
    const fontSizeDisplay = document.getElementById(`fontSizeDisplay-${tabId}`);
    
    fontSizeControl.addEventListener('input', function() {
      const size = this.value;
      fontSizeDisplay.textContent = size + 'px';
      editor.getWrapperElement().style.fontSize = size + 'px';
      editor.refresh();
    });

    editor.getWrapperElement().style.fontSize = fontSizeControl.value + 'px';
    
    // Query preview
    editor.on('cursorActivity', () => updateQueryPreview(tabId));
    editor.on('change', () => updateQueryPreview(tabId));
  }

  // Switch to a query tab
  function switchToQueryTab(tabId) {
    // Update tab appearance
    document.querySelectorAll('.query-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelector(`.query-tab[data-query-tab="${tabId}"]`).classList.add('active');

    // Update content visibility
    document.querySelectorAll('.query-tab-content').forEach(content => {
      content.classList.remove('active');
    });
    document.querySelector(`.query-tab-content[data-query-tab="${tabId}"]`).classList.add('active');

    activeQueryTab = tabId;
  }

  // Add a new query tab
  function addQueryTab() {
    const newTabId = tabCounter++;
    const newTitle = `Query ${newTabId + 1}`;
    
    queryTabs.push({
      id: newTabId,
      title: newTitle,
      editor: null,
      content: ''
    });

    createQueryTabElement(newTabId);
    switchToQueryTab(newTabId);
  }

  // Close a query tab
  function closeQueryTab(tabId, event) {
    event.stopPropagation();
    
    if (queryTabs.length <= 1) {
      alert('Vous ne pouvez pas fermer le dernier onglet.');
      return;
    }

    // Remove tab from array
    const tabIndex = queryTabs.findIndex(t => t.id === tabId);
    if (tabIndex === -1) return;
    
    queryTabs.splice(tabIndex, 1);

    // Remove DOM elements
    document.querySelector(`.query-tab[data-query-tab="${tabId}"]`).remove();
    document.querySelector(`.query-tab-content[data-query-tab="${tabId}"]`).remove();

    // Switch to another tab
    if (activeQueryTab === tabId) {
      const remainingTab = queryTabs[0];
      if (remainingTab) {
        switchToQueryTab(remainingTab.id);
      }
    }
  }

  // Initialize event listeners
  function initEventListeners() {
    // Add query tab button
    document.getElementById('addQueryTabBtn').addEventListener('click', addQueryTab);

    // Configuration
    saveConfigBtn.addEventListener('click', saveConfig);
    
    // Sidebar
    refreshStatusBtn.addEventListener('click', refreshStatus);
    refreshMetaBtn.addEventListener('click', refreshMetadata);
  }
          cluster: true, columnfamily: true, compact: true, consistency: true,
          count: true, create: true, delete: true, desc: true, describe: true,
          distinct: true, drop: true, each_quorum: true, from: true, full: true,
          grant: true, if: true, in: true, index: true, infile: true, insert: true,
          into: true, is: true, keyspace: true, keyspaces: true, level: true,
          limit: true, local_quorum: true, materialized: true, modify: true,
          no: true, not: true, null: true, of: true, on: true, one: true,
          or: true, order: true, password: true, primary: true, quorum: true,
          rename: true, revoke: true, schema: true, select: true, set: true,
          sstable: true, table: true, three: true, to: true, token: true,
          truncate: true, two: true, unlogged: true, update: true, use: true,
          using: true, view: true, where: true, with: true
        }
      },
      theme: 'default',
      lineNumbers: true,
      lineWrapping: true,
      indentWithTabs: false,
      indentUnit: 2,
      matchBrackets: true,
      autoCloseBrackets: true,
      styleActiveLine: true,
      extraKeys: {
        "Ctrl-Enter": function() { executeQuery(); },
        "Cmd-Enter": function() { executeQuery(); }
      }
    });

    // Mettre à jour la taille de police
    fontSizeControl.addEventListener('input', function() {
      const size = this.value;
      fontSizeDisplay.textContent = size + 'px';
      codeEditor.getWrapperElement().style.fontSize = size + 'px';
      codeEditor.refresh();
    });

    // Initialiser la taille
    codeEditor.getWrapperElement().style.fontSize = fontSizeControl.value + 'px';
    
    // Mettre à jour l'aperçu lors des changements
    codeEditor.on('cursorActivity', updateQueryPreview);
    codeEditor.on('change', updateQueryPreview);
  }

  // Fonction pour obtenir la valeur de l'éditeur d'un onglet
  function getEditorValue(tabId) {
    const tab = queryTabs.find(t => t.id === tabId);
    return tab && tab.editor ? tab.editor.getValue() : document.getElementById(`cql-${tabId}`).value;
  }

  // Fonction pour définir la valeur de l'éditeur d'un onglet
  function setEditorValue(tabId, value) {
    const tab = queryTabs.find(t => t.id === tabId);
    if (tab && tab.editor) {
      tab.editor.setValue(value);
    } else {
      document.getElementById(`cql-${tabId}`).value = value;
    }
  }

  // Fonction pour obtenir la sélection ou la position du curseur dans CodeMirror
  function getEditorSelection(tabId) {
    const tab = queryTabs.find(t => t.id === tabId);
    if (!tab || !tab.editor) {
      const textarea = document.getElementById(`cql-${tabId}`);
      return { start: textarea.selectionStart, end: textarea.selectionEnd };
    }
    const selection = tab.editor.getSelection();
    if (selection) {
      return { start: tab.editor.getCursor('start'), end: tab.editor.getCursor('end'), text: selection };
    }
    return { start: tab.editor.getCursor(), end: tab.editor.getCursor(), text: null };
  }

  // Afficher un aperçu de la requête qui sera exécutée
  function updateQueryPreview(tabId) {
    const query = getQueryAtCursor(tabId);
    const previewDiv = document.getElementById(`queryPreview-${tabId}`);
    if (query && query.length > 0) {
      const preview = query.length > 100 ? query.substring(0, 100) + '...' : query;
      previewDiv.textContent = 'Requête à exécuter : ' + preview.replace(/\n/g, ' ');
      previewDiv.style.display = 'block';
    } else {
      previewDiv.style.display = 'none';
    }
  }

  // Helpers de requêtes API
  async function fetchJson(url, opts = {}) {
    const res = await fetch(url, opts);
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.detail || res.statusText);
    }
    return res.json();
  }

  // ---- Métadonnées (statut, keyspaces, tables) ----
  function renderServerStatus(data) {
    if (!data || !data.connected) {
      serverStatusDiv.innerHTML = '<div class="meta-empty"><i class="fas fa-times-circle icon icon-error"></i>Non connecté.</div>';
      return;
    }
    const hosts = (data.hosts || []).join(', ');
    serverStatusDiv.innerHTML = `
      <div><i class="fas fa-check-circle icon icon-success"></i><strong>Connecté</strong></div>
      <div style="margin-top: 6px;"><i class="fas fa-network-wired icon icon-info"></i><strong>Cluster :</strong> ${data.cluster_name || 'N/A'}</div>
      <div><i class="fas fa-server icon icon-info"></i><strong>Hôtes :</strong> ${hosts || 'N/A'}</div>
      <div><i class="fas fa-database icon icon-info"></i><strong>Keyspace courant :</strong> ${data.keyspace || 'non défini'}</div>
    `;
  }

  function renderKeyspaces(list) {
    if (!list || list.length === 0) {
      keyspaceListDiv.innerHTML = '<div class="meta-empty"><i class="fas fa-info-circle icon"></i>Aucun keyspace.</div>';
      return;
    }
    keyspaceListDiv.innerHTML = '';
    list.forEach((ks) => {
      const div = document.createElement('div');
      div.className = 'meta-item' + (ks === selectedKeyspace ? ' active' : '');
      div.innerHTML = `<i class="fas fa-database icon"></i><span>${ks}</span>`;
      div.addEventListener('click', () => loadTables(ks));
      keyspaceListDiv.appendChild(div);
    });
  }

  function renderTables(tables) {
    if (!tables || tables.length === 0) {
      tableListDiv.innerHTML = '<div class="meta-empty"><i class="fas fa-info-circle icon"></i>Aucune table.</div>';
      tableDetailsDiv.innerHTML = '<i class="fas fa-mouse-pointer icon"></i>Sélectionnez une table.';
      selectedTable = null;
      return;
    }
    tableListDiv.innerHTML = '';
    tables.forEach((table) => {
      const div = document.createElement('div');
      div.className = 'meta-item' + (table.name === selectedTable ? ' active' : '');
      div.innerHTML = `
        <div class="meta-item-title"><i class="fas fa-table icon"></i>${table.name}</div>
        <div class="meta-item-sub"><i class="fas fa-columns icon"></i>${table.columns.length} colonne(s)</div>
      `;
      div.addEventListener('click', () => renderTableDetails(table));
      tableListDiv.appendChild(div);
    });
  }

  function renderTableDetails(table) {
    if (!table) {
      tableDetailsDiv.innerHTML = '<i class="fas fa-mouse-pointer icon"></i>Sélectionnez une table.';
      return;
    }
    selectedTable = table.name;
    const pk = table.partition_keys?.join(', ') || 'Aucune';
    const ck = table.clustering_keys?.join(', ') || 'Aucune';
    let cols = '';
    table.columns.forEach((c) => {
      const isPK = table.partition_keys?.includes(c.name);
      const isCK = table.clustering_keys?.includes(c.name);
      let icon = '<i class="fas fa-columns icon"></i>';
      if (isPK) icon = '<i class="fas fa-key icon icon-success"></i>';
      else if (isCK) icon = '<i class="fas fa-sort icon icon-info"></i>';
      cols += `<div style="margin-bottom: 4px;">${icon}<strong>${c.name}</strong> : <code>${c.type}</code></div>`;
    });
    tableDetailsDiv.innerHTML = `
      <div style="margin-bottom: 8px;"><i class="fas fa-table icon icon-info"></i><strong>Table :</strong> ${table.name}</div>
      <div style="margin-bottom: 4px;"><i class="fas fa-key icon icon-success"></i><strong>Partition key :</strong> ${pk}</div>
      <div style="margin-bottom: 8px;"><i class="fas fa-sort icon icon-info"></i><strong>Clustering :</strong> ${ck}</div>
      <div style="margin-top:8px; margin-bottom:4px;"><strong><i class="fas fa-list icon"></i>Colonnes :</strong></div>
      <div style="margin-top:4px;">${cols || '<div class="meta-empty">Aucune colonne</div>'}</div>
    `;
    document.querySelectorAll('#tableList .meta-item').forEach((el) => {
      const nameEl = el.querySelector('.meta-item-title');
      el.classList.toggle('active', nameEl && nameEl.textContent && nameEl.textContent.includes(table.name));
    });
  }

  async function loadStatus() {
    try {
      const data = await fetchJson('/api/status');
      renderServerStatus(data);
    } catch (e) {
      serverStatusDiv.innerHTML = `<div class="meta-empty">Erreur: ${e.message}</div>`;
    }
  }

  async function loadKeyspaces() {
    try {
      const data = await fetchJson('/api/keyspaces');
      const ksList = data.keyspaces || [];
      renderKeyspaces(ksList);
      if (selectedKeyspace && !ksList.includes(selectedKeyspace)) {
        selectedKeyspace = null;
        renderTables([]);
      }
      if (!selectedKeyspace && ksList.length > 0) {
        loadTables(ksList[0]);
      }
    } catch (e) {
      keyspaceListDiv.innerHTML = `<div class="meta-empty">Erreur: ${e.message}</div>`;
    }
  }

  async function loadTables(keyspace) {
    selectedKeyspace = keyspace;
    selectedTable = null;
    document.querySelectorAll('#keyspaceList .meta-item').forEach((el) => {
      el.classList.toggle('active', el.textContent === keyspace);
    });

    try {
      const data = await fetchJson(`/api/keyspaces/${encodeURIComponent(keyspace)}/tables`);
      renderTables(data.tables || []);
      tableDetailsDiv.innerHTML = 'Sélectionnez une table.';
    } catch (e) {
      tableListDiv.innerHTML = `<div class="meta-empty">Erreur: ${e.message}</div>`;
      tableDetailsDiv.innerHTML = 'Sélectionnez une table.';
    }
  }

  async function refreshMetadata() {
    await loadStatus();
    await loadKeyspaces();
  }

  // Gestion des requêtes sauvegardées
  const STORAGE_KEY = 'cql_saved_queries';

  function getSavedQueries() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : {};
    } catch (e) {
      return {};
    }
  }

  function saveQueries(queries) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(queries));
    } catch (e) {
      console.error('Erreur lors de la sauvegarde:', e);
    }
  }

  function loadSavedQueries() {
    // Load saved queries for all tabs
    queryTabs.forEach(tab => {
      loadSavedQueries(tab.id);
    });
  }

  function saveQuery() {
    saveCurrentQuery(activeQueryTab);
  }

  function loadQuery(name) {
    loadQuery(name, activeQueryTab);
  }

  function deleteQuery(name) {
    deleteQuery(name, activeQueryTab);
  }

  async function loadConfig() {
    try {
      const res = await fetch('/api/config');
      if (!res.ok) return;
      const cfg = await res.json();
      hostsInput.value = cfg.hosts || '';
      portInput.value = cfg.port || 9042;
      usernameInput.value = cfg.username || '';
      keyspaceInput.value = cfg.keyspace || '';
      if (cfg.connected) {
        configStatus.textContent = 'Connecté au cluster Cassandra.';
        configStatus.className = 'status success';
      } else {
        configStatus.textContent = 'Non connecté. Veuillez configurer le cluster et tester la connexion.';
        configStatus.className = 'status info';
      }
    } catch (e) {
      console.error(e);
    }
  }

  async function saveConfig() {
    configStatus.textContent = 'Test de connexion en cours...';
    configStatus.className = 'status info';

    const payload = {
      hosts: hostsInput.value || '127.0.0.1',
      port: parseInt(portInput.value || '9042', 10),
      username: usernameInput.value || '',
      password: passwordInput.value || '',
      keyspace: keyspaceInput.value || '',
    };

    try {
      const res = await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        configStatus.textContent = 'Erreur : ' + (err.detail || 'échec de connexion');
        configStatus.className = 'status error';
        return;
      }

      const data = await res.json();
      configStatus.textContent = data.message || 'Connexion réussie.';
      configStatus.className = 'status success';
      // Rafraîchir les métadonnées après connexion
      loadStatus();
      loadKeyspaces();
    } catch (e) {
      console.error(e);
      configStatus.textContent = 'Erreur réseau ou serveur lors du test de connexion.';
      configStatus.className = 'status error';
    }
  }

  function getQueryAtCursor() {
    const text = getEditorValue();
    
    if (codeEditor) {
      // Vérifier d'abord si du texte est sélectionné
      const selection = codeEditor.getSelection();
      if (selection && selection.trim().length > 0) {
        return selection.trim();
      }
      
      // Sinon, trouver la requête à la position du curseur
      const cursor = codeEditor.getCursor();
      const cursorPos = codeEditor.indexFromPos(cursor);
      
      // Chercher le point-virgule précédent
      let queryStart = 0;
      let in_string = false;
      let string_char = null;
      
      for (let i = cursorPos - 1; i >= 0; i--) {
        const char = text[i];
        if ((char === "'" || char === '"') && (i === 0 || text[i-1] !== '\\')) {
          if (!in_string) {
            in_string = true;
            string_char = char;
          } else if (char === string_char) {
            in_string = false;
            string_char = null;
          }
        }
        if (char === ';' && !in_string) {
          queryStart = i + 1;
          break;
        }
      }
      
      // Chercher le point-virgule suivant
      let queryEnd = text.length;
      in_string = false;
      string_char = null;
      
      for (let i = cursorPos; i < text.length; i++) {
        const char = text[i];
        if ((char === "'" || char === '"') && (i === 0 || text[i-1] !== '\\')) {
          if (!in_string) {
            in_string = true;
            string_char = char;
          } else if (char === string_char) {
            in_string = false;
            string_char = null;
          }
        }
        if (char === ';' && !in_string) {
          queryEnd = i;
          break;
        }
      }
      
      return text.substring(queryStart, queryEnd).trim();
    } else {
      // Fallback pour textarea classique
      const start = cqlTextarea.selectionStart;
      const end = cqlTextarea.selectionEnd;
      
      if (start !== end) {
        const selected = text.substring(start, end).trim();
        if (selected.length > 0) {
          return selected;
        }
      }
      
      // Trouver la requête à la position du curseur
      let queryStart = 0;
      let in_string = false;
      let string_char = null;
      
      for (let i = start - 1; i >= 0; i--) {
        const char = text[i];
        if ((char === "'" || char === '"') && (i === 0 || text[i-1] !== '\\')) {
          if (!in_string) {
            in_string = true;
            string_char = char;
          } else if (char === string_char) {
            in_string = false;
            string_char = null;
          }
        }
        if (char === ';' && !in_string) {
          queryStart = i + 1;
          break;
        }
      }
      
      let queryEnd = text.length;
      in_string = false;
      string_char = null;
      
      for (let i = start; i < text.length; i++) {
        const char = text[i];
        if ((char === "'" || char === '"') && (i === 0 || text[i-1] !== '\\')) {
          if (!in_string) {
            in_string = true;
            string_char = char;
          } else if (char === string_char) {
            in_string = false;
            string_char = null;
          }
        }
        if (char === ';' && !in_string) {
          queryEnd = i;
          break;
        }
      }
      
      return text.substring(queryStart, queryEnd).trim();
    }
  }

  async function executeQuery() {
    executeQuery(activeQueryTab);
  }
        statusDiv.textContent = 'Erreur : ' + (data.error || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
        return;
      }

      statusDiv.textContent = 'Requête exécutée avec succès.';
      statusDiv.classList.add('success');

      if (data.type === 'select') {
        renderTable(data.columns, data.rows);
      } else {
        resultsDiv.innerHTML = `<div>${data.message || 'OK'}</div>`;
      }

    } catch (err) {
      console.error(err);
      statusDiv.textContent = 'Erreur réseau ou serveur.';
      statusDiv.classList.add('error');
      resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l’exécution.</div>';
    }
  }

  function renderTable(columns, rows) {
    if (!rows || rows.length === 0) {
      resultsDiv.innerHTML = '<div class="results-empty">Aucune ligne retournée.</div>';
      return;
    }

    resultsDiv.innerHTML = renderTableHTML(columns, rows);
  }

  function renderTableHTML(columns, rows) {
    if (!rows || rows.length === 0) {
      return '<div class="results-empty">Aucune ligne retournée.</div>';
    }

    let html = '<table><thead><tr>';
    for (const col of columns) {
      html += `<th>${col}</th>`;
    }
    html += '</tr></thead><tbody>';

    for (const row of rows) {
      html += '<tr>';
      for (const col of columns) {
        let value = row[col];
        if (value === null || value === undefined) {
          value = '';
        } else if (typeof value === 'object') {
          value = JSON.stringify(value);
        }
        // Échapper les caractères HTML pour la sécurité
        value = String(value).replace(/</g, '&lt;').replace(/>/g, '&gt;');
        html += `<td>${value}</td>`;
      }
      html += '</tr>';
    }

    html += '</tbody></table>';
    return html;
  }

  const runAllBtn = document.getElementById('runAllBtn');

  async function executeAllQueries() {
    const query = getEditorValue().trim();
    statusDiv.textContent = '';
    statusDiv.className = 'status';

    if (!query) {
      statusDiv.textContent = 'Veuillez saisir une requête CQL.';
      statusDiv.classList.add('error');
      return;
    }

    statusDiv.textContent = 'Exécution en cours...';
    try {
      const response = await fetch('/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query }),
      });

      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        statusDiv.textContent = 'Erreur : ' + (err.detail || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
        return;
      }

      const data = await response.json();

      if (!data.success && data.type !== 'batch') {
        statusDiv.textContent = 'Erreur : ' + (data.error || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
        return;
      }

      // Gestion des résultats batch (plusieurs requêtes)
      if (data.type === 'batch') {
        statusDiv.textContent = `Exécution terminée : ${data.successful} réussie(s), ${data.failed} échouée(s) sur ${data.total_queries} requête(s).`;
        statusDiv.className = data.failed === 0 ? 'status success' : 'status error';
        
        let html = '';
        html += `<div class="batch-result-header">Résultats de ${data.total_queries} requête(s)</div>`;
        
        // Afficher les résultats réussis
        for (const result of data.results) {
          html += `<div class="batch-result success">`;
          html += `<div class="batch-result-header">Requête ${result.query_index}: ${result.query}</div>`;
          if (result.type === 'select') {
            html += `<div>${result.row_count} ligne(s) retournée(s)</div>`;
            html += renderTableHTML(result.columns, result.rows);
          } else {
            html += `<div>${result.message || 'OK'}</div>`;
          }
          html += `</div>`;
        }
        
        // Afficher les erreurs
        for (const error of data.errors) {
          html += `<div class="batch-result error">`;
          html += `<div class="batch-result-header">Requête ${error.query_index}: ${error.query}</div>`;
          html += `<div style="color: #e74c3c;">Erreur : ${error.error}</div>`;
          html += `</div>`;
        }
        
        resultsDiv.innerHTML = html;
        return;
      }

      // Gestion d'une seule requête (comportement original)
      if (!data.success) {
        statusDiv.textContent = 'Erreur : ' + (data.error || 'inconnue');
        statusDiv.classList.add('error');
        resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
        return;
      }

      statusDiv.textContent = 'Requête exécutée avec succès.';
      statusDiv.classList.add('success');

      if (data.type === 'select') {
        renderTable(data.columns, data.rows);
      } else {
        resultsDiv.innerHTML = `<div>${data.message || 'OK'}</div>`;
      }

    } catch (err) {
      console.error(err);
      statusDiv.textContent = 'Erreur réseau ou serveur.';
      statusDiv.classList.add('error');
      resultsDiv.innerHTML = '<div class="results-empty">Erreur lors de l&apos;exécution.</div>';
    }
  }

  saveConfigBtn.addEventListener('click', saveConfig);

  // Initialize query tabs when editor tab is activated
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const target = tab.getAttribute('data-tab');
      if (target === 'editor') {
        // Initialize tabs if not already done
        if (queryTabs.length === 0) {
          initQueryTabs();
        }
      }
    });
  });

  // ---- Gestion des requêtes sauvegardées ----
  function getSavedQueries() {
    const saved = localStorage.getItem('cassandra_queries');
    return saved ? JSON.parse(saved) : {};
  }

  function saveQueries(queries) {
    localStorage.setItem('cassandra_queries', JSON.stringify(queries));
  }

  function loadSavedQueries(tabId) {
    const queries = getSavedQueries();
    const listDiv = document.getElementById(`savedQueriesList-${tabId}`);
    
    if (Object.keys(queries).length === 0) {
      listDiv.innerHTML = '<div class="results-empty">Aucune requête sauvegardée.</div>';
      return;
    }

    let html = '';
    for (const [name, query] of Object.entries(queries)) {
      html += `
        <div class="saved-query-item">
          <div class="saved-query-name">${name}</div>
          <div class="saved-query-actions">
            <button onclick="loadQuery('${name}', ${tabId})" class="btn-small"><i class="fas fa-edit icon"></i></button>
            <button onclick="deleteQuery('${name}', ${tabId})" class="btn-small btn-danger"><i class="fas fa-trash icon"></i></button>
          </div>
        </div>
      `;
    }
    listDiv.innerHTML = html;
  }

  function saveCurrentQuery(tabId) {
    const queryNameInput = document.getElementById(`queryName-${tabId}`);
    const statusDiv = document.getElementById(`status-${tabId}`);
    const query = getEditorValue(tabId).trim();
    const name = queryNameInput.value.trim();

    if (!query) {
      statusDiv.textContent = 'Aucune requête à sauvegarder.';
      statusDiv.className = 'status error';
      return;
    }

    if (!name) {
      statusDiv.textContent = 'Veuillez donner un nom à cette requête.';
      statusDiv.className = 'status error';
      return;
    }

    const queries = getSavedQueries();
    queries[name] = query;
    saveQueries(queries);
    loadSavedQueries(tabId);
    queryNameInput.value = '';
    
    statusDiv.textContent = `Requête "${name}" sauvegardée.`;
    statusDiv.className = 'status success';
  }

  function loadQuery(name, tabId) {
    const queries = getSavedQueries();
    if (queries[name]) {
      setEditorValue(tabId, queries[name]);
      document.getElementById(`queryName-${tabId}`).value = name;
      const statusDiv = document.getElementById(`status-${tabId}`);
      statusDiv.textContent = `Requête "${name}" chargée.`;
      statusDiv.className = 'status success';
      if (queryTabs.find(t => t.id === tabId).editor) {
        queryTabs.find(t => t.id === tabId).editor.refresh();
      }
    }
  }

  function deleteQuery(name, tabId) {
    if (!confirm(`Supprimer la requête "${name}" ?`)) {
      return;
    }

    const queries = getSavedQueries();
    delete queries[name];
    saveQueries(queries);
    loadSavedQueries(tabId);
    
    const statusDiv = document.getElementById(`status-${tabId}`);
    statusDiv.textContent = `Requête "${name}" supprimée.`;
    statusDiv.className = 'status info';
  }

  // ---- Import/Export de fichiers ----
  function importFile(tabId) {
    const fileInput = document.getElementById(`importFile-${tabId}`);
    const file = fileInput.files[0];
    if (!file) return;

    const statusDiv = document.getElementById(`status-${tabId}`);
    statusDiv.textContent = 'Importation en cours...';
    statusDiv.className = 'status info';

    const reader = new FileReader();
    reader.onload = function(e) {
      const content = e.target.result;
      setEditorValue(tabId, content);
      statusDiv.textContent = `Fichier "${file.name}" importé avec succès.`;
      statusDiv.className = 'status success';
      
      // Réinitialiser l'input pour permettre de réimporter le même fichier
      fileInput.value = '';
    };
    
    reader.onerror = function() {
      statusDiv.textContent = 'Erreur lors de la lecture du fichier.';
      statusDiv.className = 'status error';
      fileInput.value = '';
    };
    
    reader.readAsText(file);
  }

  // ---- Exécution de toutes les requêtes ----
  async function executeAllQueries(tabId) {
    const query = getEditorValue(tabId).trim();
    if (!query) {
      const statusDiv = document.getElementById(`status-${tabId}`);
      statusDiv.textContent = 'Aucune requête à exécuter.';
      statusDiv.className = 'status error';
      return;
    }

    const resultsDiv = document.getElementById(`results-${tabId}`);
    const runAllBtn = document.getElementById(`runAllBtn-${tabId}`);
    const loadingDiv = document.getElementById(`loading-${tabId}`);

    runAllBtn.disabled = true;
    loadingDiv.style.display = 'block';
    resultsDiv.innerHTML = '';

    try {
      const response = await fetch('/execute', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: query })
      });

      const data = await response.json();

      if (data.success) {
        if (data.results && data.results.length > 0) {
          displayResults(resultsDiv, data.results);
        } else {
          resultsDiv.innerHTML = '<div class="success">Requête(s) exécutée(s) avec succès</div>';
        }
      } else {
        resultsDiv.innerHTML = `<div class="error">Erreur: ${data.error}</div>`;
      }
    } catch (error) {
      resultsDiv.innerHTML = `<div class="error">Erreur de connexion: ${error.message}</div>`;
    } finally {
      runAllBtn.disabled = false;
      loadingDiv.style.display = 'none';
    }
  }

  // ---- Affichage des résultats ----
  function displayResults(container, results) {
    if (!results || results.length === 0) {
      container.innerHTML = '<div class="results-empty">Aucun résultat.</div>';
      return;
    }

    let html = '';
    for (const result of results) {
      if (result.type === 'select' && result.columns && result.rows) {
        html += renderTableHTML(result.columns, result.rows);
      } else {
        html += `<div class="result-message">${result.message || 'OK'}</div>`;
      }
    }
    container.innerHTML = html;
  }

  function renderTableHTML(columns, rows) {
    if (!columns || !rows) return '<div class="results-empty">Aucun résultat.</div>';

    let html = '<table class="results-table"><thead><tr>';
    for (const col of columns) {
      html += `<th>${col}</th>`;
    }
    html += '</tr></thead><tbody>';

    for (const row of rows) {
      html += '<tr>';
      for (const col of columns) {
        const value = row[col] !== null && row[col] !== undefined ? row[col] : 'null';
        html += `<td>${value}</td>`;
      }
      html += '</tr>';
    }
    html += '</tbody></table>';
    return html;
  }

  loadConfig();
  loadSavedQueries();
  loadStatus();
  loadKeyspaces();
</script>
</body>
</html>



