networks:
  cassandra-net:
    driver: bridge
    name: cassandra-bridge

services:
  cassandra:
    image: cassandra:4.1
    container_name: cql-gui-cassandra
    hostname: cassandra-node
    platform: linux/amd64
    ports:
      - "9042:9042"
    environment:
      - CASSANDRA_START_RPC=true
      - CASSANDRA_SEEDS=cassandra
      - CASSANDRA_CLUSTER_NAME=CqlGuiCluster
      - CASSANDRA_DC=dc1
      - CASSANDRA_RACK=rack1
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
      - CASSANDRA_NUM_TOKENS=8
      - MAX_HEAP_SIZE=512M
      - HEAP_NEWSIZE=128M
    healthcheck:
      test: ["CMD-SHELL", "cqlsh localhost 9042 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
    volumes:
      - cassandra_data:/var/lib/cassandra
    networks:
      cassandra-net:
        aliases:
          - cassandra
          - cassandra-db

  cassandra-dc1-2:
    image: cassandra:4.1
    container_name: cassandra-dc1-2
    hostname: cassandra-dc1-2
    platform: linux/amd64
    depends_on:
      cassandra:
        condition: service_healthy
    environment:
      - CASSANDRA_START_RPC=true
      - CASSANDRA_SEEDS=cassandra
      - CASSANDRA_CLUSTER_NAME=CqlGuiCluster
      - CASSANDRA_DC=dc1
      - CASSANDRA_RACK=rack2
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
      - CASSANDRA_NUM_TOKENS=8
      - MAX_HEAP_SIZE=512M
      - HEAP_NEWSIZE=128M
    volumes:
      - cassandra_data_dc1_2:/var/lib/cassandra
    networks:
      - cassandra-net

  cassandra-dc2-1:
    image: cassandra:4.1
    container_name: cassandra-dc2-1
    hostname: cassandra-dc2-1
    platform: linux/amd64
    depends_on:
      cassandra:
        condition: service_healthy
    environment:
      - CASSANDRA_START_RPC=true
      - CASSANDRA_SEEDS=cassandra
      - CASSANDRA_CLUSTER_NAME=CqlGuiCluster
      - CASSANDRA_DC=dc2
      - CASSANDRA_RACK=rack1
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
      - CASSANDRA_NUM_TOKENS=8
      - MAX_HEAP_SIZE=512M
      - HEAP_NEWSIZE=128M
    ports:
      - "9043:9042"
    volumes:
      - cassandra_data_dc2_1:/var/lib/cassandra
    networks:
      - cassandra-net

  cassandra-dc2-2:
    image: cassandra:4.1
    container_name: cassandra-dc2-2
    hostname: cassandra-dc2-2
    platform: linux/amd64
    depends_on:
      cassandra-dc2-1:
        condition: service_started
    environment:
      - CASSANDRA_START_RPC=true
      - CASSANDRA_SEEDS=cassandra
      - CASSANDRA_CLUSTER_NAME=CqlGuiCluster
      - CASSANDRA_DC=dc2
      - CASSANDRA_RACK=rack2
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
      - CASSANDRA_NUM_TOKENS=8
      - MAX_HEAP_SIZE=512M
      - HEAP_NEWSIZE=128M
    volumes:
      - cassandra_data_dc2_2:/var/lib/cassandra
    networks:
      - cassandra-net

  cassandra-init:
    image: cassandra:4.1
    container_name: cassandra-init
    platform: linux/amd64
    depends_on:
      cassandra:
        condition: service_healthy
    restart: "no"
    volumes:
      - ./cql-scripts:/cql-scripts
    entrypoint: ["sh", "-c"]
    command: >
      "until cqlsh cassandra 9042 -e 'DESCRIBE CLUSTER' >/dev/null 2>&1; do sleep 2; done;
      cqlsh cassandra 9042 -f /cql-scripts/atelier.cql"
    networks:
      - cassandra-net

  cql-gui:
    build: ./gui-cql
    container_name: cql-gui-app
    hostname: cql-gui-app
    platform: linux/amd64
    depends_on:
      cassandra:
        condition: service_healthy
      cassandra-init:
        condition: service_completed_successfully
    environment:
      - CASSANDRA_HOSTS=cassandra,cassandra-dc2-1
      - CASSANDRA_PORT=9042
      # - CASSANDRA_KEYSPACE=mon_keyspace
      # - CASSANDRA_USER=username
      # - CASSANDRA_PASSWORD=password
    ports:
      - "8889:8000"
    volumes:
      - ./cql-scripts:/app/cql-scripts
    networks:
      - cassandra-net

  fleet-dashboard:
    build: ./fleet-dashboard
    container_name: fleet-dashboard
    hostname: fleet-dashboard
    platform: linux/amd64
    depends_on:
      cassandra:
        condition: service_healthy
      cassandra-init:
        condition: service_completed_successfully
    environment:
      - CASSANDRA_HOSTS=cassandra,cassandra-dc2-1
      - CASSANDRA_PORT=9042
      - CASSANDRA_KEYSPACE=atelier
    ports:
      - "8501:8501"
    networks:
      - cassandra-net

  jupyter:
    image: quay.io/jupyter/base-notebook
    ports:
      - 8888:8888
    volumes:
      - ./jupyter-data:/home/jovyan/work
    command: start-notebook.py --NotebookApp.token='my-token'
    networks:
      - cassandra-net
volumes:
  jupyter-data:
    name: jupyter-data
  cassandra_data:
  cassandra_data_dc1_2:
  cassandra_data_dc2_1:
  cassandra_data_dc2_2:
